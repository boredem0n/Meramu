<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meramu App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/phosphor-icons"></script>
    <script>
        // Custom Tailwind configuration
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark-green': '#102820',
                        'brand-hunter-green': '#4C6444',
                        'brand-khaki': '#CABA9C',
                        'brand-umber': '#8A6240',
                        'brand-cafe-noir': '#4D2D18',
                        'brand-bg': '#F7F5F2' // Lighter khaki for background
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Hide scrollbar for cleaner look */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* Custom modal styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-brand-bg">

    <div id="app" class="max-w-sm mx-auto bg-white min-h-screen shadow-lg">
        <!-- Main App Content -->
        <main id="main-content" class="pb-20">
            <!-- All pages will be rendered here -->
        </main>

        <!-- Floating Cart Bar -->
        <div id="floating-cart-bar" class="fixed bottom-16 max-w-sm w-full p-3 bg-brand-dark-green text-white hidden z-40">
             <div class="flex justify-between items-center">
                <div>
                    <p id="floating-cart-items" class="font-bold">1 Item</p>
                    <p id="floating-cart-total" class="text-sm">Rp 15,000</p>
                </div>
                <button onclick="navigateTo('cart')" class="bg-brand-hunter-green font-bold px-6 py-2 rounded-lg">Pay Now</button>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <nav class="fixed bottom-0 max-w-sm mx-auto w-full bg-white border-t border-gray-200 flex justify-around items-center h-16 z-50">
            <button onclick="navigateTo('home')" class="text-center text-gray-600 hover:text-brand-hunter-green transition-colors">
                <i class="ph-house text-2xl"></i>
                <span class="text-xs block">Home</span>
            </button>
            <button onclick="navigateTo('voucher')" class="text-center text-gray-600 hover:text-brand-hunter-green transition-colors">
                <i class="ph-ticket text-2xl"></i>
                <span class="text-xs block">Voucher</span>
            </button>
            <button onclick="navigateTo('racikan')" class="text-center">
                 <div class="bg-brand-hunter-green text-white rounded-full w-16 h-16 flex items-center justify-center -mt-8 border-4 border-white shadow-md">
                    <i class="ph-flask text-3xl"></i>
                </div>
            </button>
            <button onclick="navigateTo('orderHistory')" class="text-center text-gray-600 hover:text-brand-hunter-green transition-colors">
                <i class="ph-receipt text-2xl"></i>
                <span class="text-xs block">Order</span>
            </button>
            <button onclick="navigateTo('account')" class="text-center text-gray-600 hover:text-brand-hunter-green transition-colors">
                <i class="ph-user text-2xl"></i>
                <span class="text-xs block">Account</span>
            </button>
        </nav>
        
        <!-- Custom Alert Modal -->
        <div id="custom-alert-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] opacity-0 pointer-events-none">
            <div class="modal-content bg-white rounded-lg p-6 text-center shadow-xl transform scale-95">
                <p id="custom-alert-message" class="mb-4 text-brand-cafe-noir"></p>
                <button onclick="hideCustomAlert()" class="bg-brand-hunter-green text-white px-6 py-2 rounded-lg">OK</button>
            </div>
        </div>

    </div>

    <script>
        const mainContent = document.getElementById('main-content');
        // --- GLOBAL STATE ---
        let cart = [];
        let orderHistory = [
            { id: 'ORD001', status: 'Pesanan sedang diantar', items: [{ name: 'Jahe Wangi', quantity: 2 }], total: 20000 },
            { id: 'ORD002', status: 'Si Mbok sedang menyiapkan pesanan', items: [{ name: 'Es Kopi Kayu Manis', quantity: 1 }, { name: 'Panada', quantity: 1 }], total: 30000 },
            { id: 'ORD003', status: 'Pesanan sudah dibayar', items: [{ name: 'Jamu Racikan Sendiri', quantity: 1 }], total: 18000 }
        ];
        let subtotal = 0;
        let deliveryFee = 0;
        let deliveryType = 'pickup';
        let deliveryAddress = null;

        // --- DATA ---
        const products = {
            panas: [
                { id: 1, name: 'Jahe Wangi', price: 10000, img: 'https://placehold.co/150x150/a855f7/white?text=Jahe+Wangi' },
                { id: 2, name: 'Kopi Tubruk', price: 8000, img: 'https://placehold.co/150x150/f97316/white?text=Kopi+Tubruk' },
                { id: 3, name: 'Wedang Bolique', price: 12000, img: 'https://placehold.co/150x150/14b8a6/white?text=Wedang+B' },
                { id: 4, name: 'Wedang Secang', price: 11000, img: 'https://placehold.co/150x150/ec4899/white?text=Wedang+S' },
            ],
            dingin: [
                { id: 5, name: 'Kunir Asem', price: 8000, img: 'https://placehold.co/150x150/f59e0b/white?text=Kunir+Asem' },
                { id: 6, name: 'Beras Kencur', price: 8000, img: 'https://placehold.co/150x150/84cc16/white?text=Beras+Kencur' },
                { id: 7, name: 'Es Teh Sereh', price: 7500, img: 'https://placehold.co/150x150/10b981/white?text=Es+Teh+Sereh' },
                { id: 8, name: 'Es Kopi Kayu Manis', price: 15000, img: 'https://placehold.co/150x150/6366f1/white?text=Es+Kopi' },
            ],
            kudapan: [
                { id: 9, name: 'Panada (isi 3)', price: 15000, img: 'https://placehold.co/150x150/ef4444/white?text=Panada' },
                { id: 10, name: 'Timus Ubi Ungu', price: 12000, img: 'https://placehold.co/150x150/8b5cf6/white?text=Timus' },
                { id: 11, name: 'Pisang Epe', price: 10000, img: 'https://placehold.co/150x150/eab308/white?text=Pisang+Epe' },
            ]
        };
        
        const racikanOptions = {
            temperature: [{ name: 'Iced', price: 0 }, { name: 'Hot', price: 3000 }],
            base: [{ name: 'Water', price: 0 }, { name: 'Teh', price: 2000 }, { name: 'Kopi', price: 5000 }, { name: 'Fresh Milk', price: 3000 }, { name: 'Soy Milk', price: 7000 }, { name: 'Susu Almond', price: 7000 }],
            size: [{ name: 'Regular', price: 0 }, { name: 'Xtra', price: 5000 }],
            herbs: [{ name: 'Jahe', price: 1000 }, { name: 'Kencur', price: 1000 }, { name: 'Kunir', price: 1000 }, { name: 'Temulawak', price: 1500 }, { name: 'Cengkeh', price: 1500 }, { name: 'Sereh', price: 1000 }, { name: 'Kayu Manis', price: 2000 }, { name: 'Secang', price: 1500 }, { name: 'Sambiloto', price: 2000 }],
            sugar: [{ name: 'No Sugar', price: 0 }, { name: 'White Sugar', price: 0 }, { name: 'Palm Sugar', price: 0 }, { name: 'Diabetic Sugar', price: 5000 }],
            addMore: [{ name: 'Espresso Shot', price: 5000 }, { name: 'Manuka Honey', price: 3000 }]
        };
        let currentRacikan = {};
        
        const mockAddresses = [{ address: 'Simpang Lima, Semarang', distance: 4.5 }, { address: 'Lawang Sewu, Semarang', distance: 6.2 }, { address: 'Jatingaleh, Semarang', distance: 16.0 }];
        
        // --- HELPER FUNCTIONS ---
        function showCustomAlert(message) {
            const modal = document.getElementById('custom-alert-modal');
            document.getElementById('custom-alert-message').innerText = message;
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.remove('scale-95');
        }

        function hideCustomAlert() {
            const modal = document.getElementById('custom-alert-modal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('.modal-content').classList.add('scale-95');
        }
        
        function updateFloatingCart() {
            const bar = document.getElementById('floating-cart-bar');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const currentTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

            if (totalItems > 0) {
                document.getElementById('floating-cart-items').innerText = `${totalItems} Item${totalItems > 1 ? 's' : ''}`;
                document.getElementById('floating-cart-total').innerText = `Rp ${currentTotal.toLocaleString('id-ID')}`;
                bar.classList.remove('hidden');
            } else {
                bar.classList.add('hidden');
            }
        }

        function addToCart(customizedProduct) {
            const optionsId = customizedProduct.options.map(opt => `${opt.type}:${opt.value}`).sort().join('|');
            const uniqueId = `${customizedProduct.id}-${optionsId}`;
            const existingItem = cart.find(item => item.uniqueId === uniqueId);

            if (existingItem) {
                existingItem.quantity += customizedProduct.quantity;
            } else {
                cart.push({ ...customizedProduct, uniqueId });
            }
            
            updateFloatingCart();
            showCustomAlert(`${customizedProduct.quantity}x ${customizedProduct.name} added to cart!`);
        }
        
        function finalizeOrder() {
            if (cart.length === 0) {
                showCustomAlert("Your cart is empty.");
                return;
            }
            const newOrder = {
                id: `ORD00${orderHistory.length + 1}`,
                status: 'Pesanan sudah dibayar',
                items: cart.map(item => ({ name: item.name, quantity: item.quantity })),
                total: subtotal + (deliveryFee > 0 ? deliveryFee : 0)
            };
            orderHistory.unshift(newOrder); // Add to the top of the history
            cart = []; // Clear the cart
            updateFloatingCart();
            showCustomAlert("Payment successful! Your order has been placed.");
            navigateTo('orderHistory');
        }
        
        // --- PAGE TEMPLATES ---

        function homePage() {
            return `
                <div class="p-4 bg-brand-bg">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <div class="text-2xl font-bold text-brand-dark-green">Meramu</div>
                            <p class="text-brand-cafe-noir">Hi, User!</p>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center gap-2 bg-brand-umber text-white font-bold py-1 px-3 rounded-full">
                                <i class="ph-star-fill"></i>
                                <span>0 Pts</span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-brand-hunter-green text-white rounded-lg p-6 mb-6 text-center shadow-lg">
                        <h2 class="font-bold text-xl mb-2">Monday Discount</h2>
                        <p>Buy 1 Get 1 for Es Kopi Kayu Manis!</p>
                    </div>
                    <h3 class="font-bold text-lg mb-3 text-brand-cafe-noir">Category</h3>
                    <div class="grid grid-cols-4 gap-4 text-center mb-6">
                        <div onclick="navigateTo('category', 'panas')" class="cursor-pointer">
                            <div class="bg-white rounded-lg p-3 mb-1 flex items-center justify-center h-16 shadow"><i class="ph-coffee text-3xl text-brand-hunter-green"></i></div>
                            <span class="text-sm text-brand-cafe-noir">Panas</span>
                        </div>
                        <div onclick="navigateTo('category', 'dingin')" class="cursor-pointer">
                            <div class="bg-white rounded-lg p-3 mb-1 flex items-center justify-center h-16 shadow"><i class="ph-brandy text-3xl text-brand-hunter-green"></i></div>
                            <span class="text-sm text-brand-cafe-noir">Dingin</span>
                        </div>
                        <div onclick="navigateTo('category', 'kudapan')" class="cursor-pointer">
                            <div class="bg-white rounded-lg p-3 mb-1 flex items-center justify-center h-16 shadow"><i class="ph-cookie text-3xl text-brand-hunter-green"></i></div>
                            <span class="text-sm text-brand-cafe-noir">Kudapan</span>
                        </div>
                         <div onclick="navigateTo('recipe')" class="cursor-pointer">
                            <div class="bg-white rounded-lg p-3 mb-1 flex items-center justify-center h-16 shadow"><i class="ph-notebook text-3xl text-brand-hunter-green"></i></div>
                            <span class="text-sm text-brand-cafe-noir">Recipe</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg text-brand-cafe-noir">Popular!</h3>
                        <div onclick="navigateTo('bot')" class="bg-brand-umber text-white px-4 py-2 rounded-full flex items-center gap-2 cursor-pointer shadow">
                           <i class="ph-robot"></i>
                           <span>Konsul Si Mbok</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 pb-24">
                        ${products.dingin.map(p => `
                            <div class="bg-white rounded-lg shadow p-2" onclick="navigateTo('product', {type: 'dingin', id: ${p.id}})">
                                <img src="${p.img}" alt="${p.name}" class="rounded-md w-full h-24 object-cover mb-2">
                                <h4 class="font-semibold text-brand-cafe-noir">${p.name}</h4>
                                <p class="text-brand-umber">Rp ${p.price.toLocaleString('id-ID')}</p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function categoryPage(category) {
             const categoryTitle = category.charAt(0).toUpperCase() + category.slice(1);
            const productList = products[category];

            return `
                <div class="p-4 bg-brand-bg">
                    <div class="flex items-center mb-4">
                        <button onclick="navigateTo('home')" class="mr-4 text-brand-dark-green"><i class="ph-arrow-left text-2xl"></i></button>
                        <h2 class="font-bold text-xl text-brand-dark-green">${categoryTitle}</h2>
                    </div>
                    <div class="grid grid-cols-2 gap-4 pb-24">
                        ${(productList || []).map(p => `
                            <div class="bg-white rounded-lg shadow p-3 text-center cursor-pointer" onclick="navigateTo('product', {type: '${category}', id: ${p.id}})">
                                <img src="${p.img}" alt="${p.name}" class="rounded-md w-full h-24 object-cover mb-2">
                                <h4 class="font-semibold text-brand-cafe-noir">${p.name}</h4>
                                <p class="text-brand-umber">Rp ${p.price.toLocaleString('id-ID')}</p>
                                <button class="mt-2 bg-brand-hunter-green text-white w-full py-1 rounded-lg font-semibold">+</button>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function productPage(params) {
             const { type, id } = params;
            const product = products[type].find(p => p.id === id);
            
            window.currentProductState = { quantity: 1, basePrice: product.price, totalPrice: product.price };

            window.updateProductPrice = () => {
                let newPrice = currentProductState.basePrice;
                const options = [];
                const size = document.querySelector('input[name="size"]:checked');
                if (size) { if(size.dataset.price) newPrice += parseInt(size.dataset.price); options.push({ type: 'Size', value: size.dataset.label }); }
                const sugar = document.querySelector('input[name="sugar"]:checked');
                if (sugar) { if(sugar.dataset.price) newPrice += parseInt(sugar.dataset.price); options.push({ type: 'Sugar', value: sugar.dataset.label }); }
                const sugarLevel = document.querySelector('input[name="sugar-level"]:checked');
                if (sugarLevel) { options.push({ type: 'Level', value: sugarLevel.dataset.label }); }
                const addOns = document.querySelectorAll('input[name="addon"]:checked');
                addOns.forEach(addon => { newPrice += parseInt(addon.dataset.price); options.push({ type: 'Add-on', value: addon.dataset.label }); });
                currentProductState.totalPrice = newPrice;
                currentProductState.options = options;
                document.getElementById('product-price').innerText = `Rp ${currentProductState.totalPrice.toLocaleString('id-ID')}`;
                document.getElementById('add-to-cart-btn').innerText = `Add to Cart - Rp ${(currentProductState.totalPrice * currentProductState.quantity).toLocaleString('id-ID')}`;
            };

            window.changeProductQuantity = (amount) => {
                if (currentProductState.quantity + amount >= 1) {
                    currentProductState.quantity += amount;
                    document.getElementById('product-quantity').innerText = currentProductState.quantity;
                    updateProductPrice();
                }
            };
            
            window.finalizeAddToCart = () => {
                const finalProduct = { id: product.id, name: product.name, quantity: currentProductState.quantity, price: currentProductState.totalPrice, options: currentProductState.options };
                addToCart(finalProduct);
            };

            setTimeout(updateProductPrice, 0); 

            return `
                <div class="relative bg-brand-bg">
                    <div class="p-4 flex items-center absolute top-0 left-0 w-full bg-gradient-to-b from-black/50 to-transparent z-10">
                        <button onclick="navigateTo('category', '${type}')" class="mr-4 text-white"><i class="ph-arrow-left text-2xl"></i></button>
                    </div>
                    <img src="${product.img.replace('150x150', '400x300')}" alt="${product.name}" class="w-full h-60 object-cover">
                    <div class="px-4 pt-4 bg-white rounded-t-2xl -mt-4 relative">
                        <h2 class="font-bold text-2xl mb-1 text-brand-dark-green">${product.name}</h2>
                        <p id="product-price" class="text-xl font-semibold text-brand-hunter-green mb-6">Rp ${product.price.toLocaleString('id-ID')}</p>
                        ${type !== 'kudapan' ? `
                        <div class="mb-4"><h3 class="font-semibold mb-2 text-brand-cafe-noir">Size</h3><div class="flex gap-4"><label class="flex-1"><input type="radio" name="size" class="sr-only peer" onchange="updateProductPrice()" data-label="Regular" ${type === 'panas' || type === 'dingin' ? 'checked' : ''}><div class="p-3 border rounded-lg text-center peer-checked:bg-green-100 peer-checked:border-brand-hunter-green text-brand-cafe-noir">Regular</div></label>${type === 'dingin' ? `<label class="flex-1"><input type="radio" name="size" data-price="5000" data-label="Xtra" class="sr-only peer" onchange="updateProductPrice()"><div class="p-3 border rounded-lg text-center peer-checked:bg-green-100 peer-checked:border-brand-hunter-green text-brand-cafe-noir">Xtra (+Rp 5,000)</div></label>` : ''}</div></div>
                        <div class="mb-4"><h3 class="font-semibold mb-2 text-brand-cafe-noir">Sugar</h3><div class="grid grid-cols-2 gap-2"><label><input type="radio" name="sugar" onchange="updateProductPrice()" data-label="White Sugar" checked><span class="ml-2 text-brand-cafe-noir">White Sugar</span></label><label><input type="radio" name="sugar" onchange="updateProductPrice()" data-label="Palm Sugar"><span class="ml-2 text-brand-cafe-noir">Palm Sugar</span></label><label><input type="radio" name="sugar" data-price="5000" onchange="updateProductPrice()" data-label="Diabetic Sugar"><span class="ml-2 text-brand-cafe-noir">Diabetic Sugar (+Rp 5,000)</span></label><label><input type="radio" name="sugar" onchange="updateProductPrice()" data-label="No Sugar"><span class="ml-2 text-brand-cafe-noir">No Sugar</span></label></div></div>
                        <div class="mb-4"><h3 class="font-semibold mb-2 text-brand-cafe-noir">Sugar Level</h3><div class="grid grid-cols-2 gap-2"><label><input type="radio" name="sugar-level" data-label="Normal" onchange="updateProductPrice()" checked><span class="ml-2 text-brand-cafe-noir">Normal</span></label><label><input type="radio" name="sugar-level" data-label="Less" onchange="updateProductPrice()"><span class="ml-2 text-brand-cafe-noir">Less</span></label><label><input type="radio" name="sugar-level" data-label="Extra" onchange="updateProductPrice()"><span class="ml-2 text-brand-cafe-noir">Extra</span></label></div></div>
                        <div class="mb-4"><h3 class="font-semibold mb-2 text-brand-cafe-noir">Add More</h3><div class="space-y-2"><label class="flex items-center justify-between p-3 border rounded-lg"><span>Espresso Shot <span class="text-gray-500">(+Rp 5,000)</span></span><input type="checkbox" name="addon" data-price="5000" data-label="Espresso Shot" onchange="updateProductPrice()" class="h-5 w-5 rounded text-brand-hunter-green focus:ring-brand-hunter-green"></label><label class="flex items-center justify-between p-3 border rounded-lg"><span>Manuka Honey <span class="text-gray-500">(+Rp 3,000)</span></span><input type="checkbox" name="addon" data-price="3000" data-label="Manuka Honey" onchange="updateProductPrice()" class="h-5 w-5 rounded text-brand-hunter-green focus:ring-brand-hunter-green"></label></div></div>
                        ` : ''}
                        <div class="flex items-center justify-center gap-4 my-6"><button onclick="changeProductQuantity(-1)" class="bg-gray-200 rounded-full w-10 h-10 text-2xl font-bold text-brand-cafe-noir flex-shrink-0">-</button><span id="product-quantity" class="text-2xl font-bold text-brand-dark-green min-w-[40px] text-center">1</span><button onclick="changeProductQuantity(1)" class="bg-gray-200 rounded-full w-10 h-10 text-2xl font-bold text-brand-cafe-noir flex-shrink-0">+</button></div>
                        <div class="h-32"></div>
                    </div>
                    <div class="fixed bottom-16 max-w-sm w-full p-4 bg-white border-t"><button id="add-to-cart-btn" onclick='finalizeAddToCart()' class="w-full bg-brand-hunter-green text-white py-3 rounded-lg font-bold">Add to Cart</button></div>
                </div>
            `;
        }
        
        // --- CART PAGE (A5) ---
        function cartPage() {
            updateCartSummary();
            return `
                <div class="p-4 bg-brand-bg min-h-screen">
                    <div class="flex items-center mb-4"><button onclick="navigateTo('home')" class="mr-4"><i class="ph-arrow-left text-2xl text-brand-dark-green"></i></button><h2 class="font-bold text-xl text-brand-dark-green">Your Cart</h2></div>
                    <div id="cart-items-container" class="space-y-3 mb-4">${renderCartItems()} ${cart.length === 0 ? `<p class="text-center text-brand-cafe-noir">Your cart is empty.</p>` : ''}</div>
                    <div class="bg-white rounded-lg shadow p-4 mb-4">
                        <h3 class="font-bold mb-3 text-brand-cafe-noir">Delivery Option</h3>
                        <div class="flex gap-4 mb-4">
                            <button onclick="selectDeliveryType('pickup')" class="flex-1 border-2 font-semibold py-3 rounded-lg ${deliveryType === 'pickup' ? 'bg-brand-khaki border-brand-hunter-green text-brand-dark-green' : 'bg-gray-100 border-gray-200 text-gray-600'}">Pick-up</button>
                            <button onclick="selectDeliveryType('delivery')" class="flex-1 border-2 font-semibold py-3 rounded-lg ${deliveryType === 'delivery' ? 'bg-brand-khaki border-brand-hunter-green text-brand-dark-green' : 'bg-gray-100 border-gray-200 text-gray-600'}">Delivery</button>
                        </div>
                        ${deliveryType === 'delivery' ? `<div class="mt-4 relative"><h4 class="font-semibold text-brand-cafe-noir mb-2">Enter Delivery Address</h4><input type="text" id="address-input" onkeyup="searchAddress(this.value)" placeholder="Start typing your address..." class="w-full border rounded-lg p-2" value="${deliveryAddress ? deliveryAddress.address : ''}"><div id="address-suggestions" class="absolute w-full bg-white border rounded-lg mt-1 shadow-lg z-20"></div><div class="h-32 bg-gray-200 rounded-lg mt-4 flex items-center justify-center text-gray-500">Map Placeholder</div></div>` : ''}
                    </div>
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-bold mb-3 text-brand-cafe-noir">Payment Summary</h3>
                        <div class="flex justify-between text-brand-cafe-noir mb-1"><span>Subtotal</span><span id="subtotal">Rp ${subtotal.toLocaleString('id-ID')}</span></div>
                        <div class="flex justify-between text-brand-cafe-noir mb-3"><span>Delivery Fee</span><span id="delivery-fee">Rp ${deliveryFee < 0 ? 'N/A' : deliveryFee.toLocaleString('id-ID')}</span></div>
                        <hr class="my-2">
                        <div class="flex justify-between font-bold text-lg text-brand-dark-green"><span>Total</span><span id="total-price">Rp ${(subtotal + (deliveryFee > 0 ? deliveryFee : 0)).toLocaleString('id-ID')}</span></div>
                    </div>
                    <div class="h-32"></div>
                    <div class="fixed bottom-16 max-w-sm w-full p-4 bg-white border-t"><button id="payment-btn" onclick="navigateTo('payment')" class="w-full bg-brand-hunter-green text-white py-3 rounded-lg font-bold">Continue to Payment</button></div>
                </div>
            `;
        }

        // --- ORDER HISTORY PAGE ---
        function orderHistoryPage() {
            return `
                <div class="p-4 bg-brand-bg min-h-screen">
                    <div class="flex items-center mb-4"><h2 class="font-bold text-xl text-brand-dark-green">My Orders</h2></div>
                    <div class="space-y-4">
                        ${orderHistory.length === 0 ? `<p class="text-center text-brand-cafe-noir">You have no past orders.</p>` : ''}
                        ${orderHistory.map(order => `
                            <div class="bg-white p-4 rounded-lg shadow">
                                <div class="flex justify-between items-center mb-2"><span class="font-bold text-brand-dark-green">${order.id}</span><span class="text-sm font-semibold px-2 py-1 rounded-full ${order.status.includes('diantar') ? 'bg-blue-100 text-blue-800' : ''} ${order.status.includes('menyiapkan') ? 'bg-yellow-100 text-yellow-800' : ''} ${order.status.includes('dibayar') ? 'bg-green-100 text-green-800' : ''}">${order.status}</span></div>
                                <hr class="my-2">
                                <div class="space-y-1">${order.items.map(item => `<div class="flex justify-between text-brand-cafe-noir"><span>${item.quantity}x ${item.name}</span></div>`).join('')}</div>
                                <div class="text-right font-bold mt-2 text-brand-umber">Total: Rp ${order.total.toLocaleString('id-ID')}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // --- RACIKAN PAGE ---
        let racikanStep = 1;

        function updateRacikanPrice() {
            let price = 0;
            if (currentRacikan.temperature) price += currentRacikan.temperature.price;
            if (currentRacikan.base) price += currentRacikan.base.price;
            if (currentRacikan.size) price += currentRacikan.size.price;
            if (currentRacikan.herbs) currentRacikan.herbs.forEach(herb => price += herb.price);
            if (currentRacikan.sugar) price += currentRacikan.sugar.price;
            if (currentRacikan.addMore) currentRacikan.addMore.forEach(add => price += add.price);
            currentRacikan.totalPrice = price;
            document.getElementById('racikan-price').innerText = `Rp ${price.toLocaleString('id-ID')}`;
        }
        
        window.handleHerbSelection = (checkbox, herbJson) => {
            const herb = JSON.parse(herbJson);
            if (!currentRacikan.herbs) currentRacikan.herbs = [];
            if (checkbox.checked) {
                if (currentRacikan.herbs.length < 3) { currentRacikan.herbs.push(herb); } 
                else { checkbox.checked = false; showCustomAlert("You can only choose a maximum of 3 herbs."); }
            } else {
                currentRacikan.herbs = currentRacikan.herbs.filter(h => h.name !== herb.name);
            }
            document.getElementById('herb-count').innerText = `${currentRacikan.herbs.length}/3 selected`;
            updateRacikanPrice();
        };
        
        window.finalizeRacikan = () => {
            const name = document.getElementById('racikan-name')?.value || "Jamu Racikan Sendiri";
            const options = [];
            if(currentRacikan.temperature) options.push({type: 'Temp', value: currentRacikan.temperature.name});
            if(currentRacikan.base) options.push({type: 'Base', value: currentRacikan.base.name});
            if(currentRacikan.herbs) options.push({type: 'Herbs', value: currentRacikan.herbs.map(h => h.name).join(', ')});
            if(currentRacikan.sugar) options.push({type: 'Sugar', value: currentRacikan.sugar.name});

            const racikanProduct = {
                id: 99, name: name, quantity: 1, price: currentRacikan.totalPrice, options: options
            };
            addToCart(racikanProduct);
            navigateTo('cart');
        };

        function racikanPage() {
            if (racikanStep === 1) { currentRacikan = { totalPrice: 0 }; }
            const renderStep = () => {
                switch(racikanStep) {
                    case 1: return `<h3 class="font-bold text-xl mb-4 text-brand-cafe-noir">Choose Temperature & Base</h3><div class="mb-6"><h4 class="font-semibold mb-2 text-brand-cafe-noir">Temperature</h4><div class="grid grid-cols-2 gap-4">${racikanOptions.temperature.map(opt => `<label><input type="radio" name="temperature" class="sr-only peer" value='${JSON.stringify(opt)}' onchange="currentRacikan.temperature = JSON.parse(this.value); updateRacikanPrice();"><div class="p-4 border rounded-lg text-center peer-checked:bg-green-100 peer-checked:border-brand-hunter-green">${opt.name} ${opt.price > 0 ? `(+${opt.price/1000}k)`: ''}</div></label>`).join('')}</div></div><div><h4 class="font-semibold mb-2 text-brand-cafe-noir">Base</h4><div class="grid grid-cols-2 gap-4">${racikanOptions.base.map(opt => `<label><input type="radio" name="base" class="sr-only peer" value='${JSON.stringify(opt)}' onchange="currentRacikan.base = JSON.parse(this.value); updateRacikanPrice();"><div class="p-4 border rounded-lg text-center peer-checked:bg-green-100 peer-checked:border-brand-hunter-green">${opt.name} ${opt.price > 0 ? `(+${opt.price/1000}k)`: ''}</div></label>`).join('')}</div></div>`;
                    case 2: return `<h3 class="font-bold text-xl mb-2 text-brand-cafe-noir">Choose Herbs</h3><p class="text-brand-umber mb-4" id="herb-count">0/3 selected</p><div class="grid grid-cols-3 gap-4 h-64 overflow-y-auto no-scrollbar p-1">${racikanOptions.herbs.map(herb => `<label class="text-center"><input type="checkbox" name="herb" class="sr-only peer" value='${JSON.stringify(herb)}' onchange="handleHerbSelection(this, this.value)"><div class="p-2 border rounded-lg peer-checked:bg-green-100 peer-checked:border-brand-hunter-green"><div class="bg-gray-200 h-16 rounded-md mb-2"></div><span class="text-sm">${herb.name}</span><p class="text-xs text-brand-umber">+${herb.price/1000}k</p></div></label>`).join('')}</div>`;
                    case 3: return `<h3 class="font-bold text-xl mb-4 text-brand-cafe-noir">Sugar & Add-ons</h3><div class="mb-6"><h4 class="font-semibold mb-2 text-brand-cafe-noir">Sugar Type</h4><div class="grid grid-cols-2 gap-2">${racikanOptions.sugar.map(opt => `<label><input type="radio" name="sugar" class="sr-only peer" value='${JSON.stringify(opt)}' onchange="currentRacikan.sugar = JSON.parse(this.value); updateRacikanPrice();"><div class="p-3 border rounded-lg text-center peer-checked:bg-green-100 peer-checked:border-brand-hunter-green">${opt.name} ${opt.price > 0 ? `(+${opt.price/1000}k)`: ''}</div></label>`).join('')}</div></div><div><h4 class="font-semibold mb-2 text-brand-cafe-noir">Add More</h4><div class="space-y-2">${racikanOptions.addMore.map(opt => `<label class="flex items-center justify-between p-3 border rounded-lg"><span>${opt.name} <span class="text-gray-500">(+Rp ${opt.price.toLocaleString('id-ID')})</span></span><input type="checkbox" name="addon" onchange="updateRacikanPrice()" class="h-5 w-5 rounded text-brand-hunter-green focus:ring-brand-hunter-green"></label>`).join('')}</div></div>`;
                    case 4: return `<h3 class="font-bold text-xl mb-4 text-brand-cafe-noir">Name Your Jamu!</h3><input type="text" id="racikan-name" placeholder="e.g., Jamu Kuat Pagi" class="w-full border rounded-lg p-3 text-brand-cafe-noir" onchange="currentRacikan.name = this.value"><div class="mt-6 bg-gray-50 p-3 rounded-lg"><h4 class="font-semibold text-brand-cafe-noir mb-2">Your Creation:</h4><p class="text-brand-umber">${Object.values(currentRacikan).map(v => v.name).filter(Boolean).join(', ')}</p></div>`;
                    default: return '';
                }
            }
            return `<div class="p-4 bg-brand-bg min-h-screen flex flex-col"><div class="flex items-center mb-4"><button onclick="racikanStep > 1 ? (racikanStep--, navigateTo('racikan')) : navigateTo('home')" class="mr-4"><i class="ph-arrow-left text-2xl text-brand-dark-green"></i></button><h2 class="font-bold text-xl text-brand-dark-green">Racikan Sendiri</h2></div><div class="w-full bg-gray-200 rounded-full h-2.5 mb-6"><div class="bg-brand-hunter-green h-2.5 rounded-full" style="width: ${racikanStep * 25}%"></div></div><div class="flex-1">${renderStep()}</div><div class="fixed bottom-16 max-w-sm w-full p-4 bg-white border-t"><div class="flex justify-between items-center mb-2"><span class="font-semibold text-brand-cafe-noir">Total Price</span><span id="racikan-price" class="font-bold text-xl text-brand-hunter-green">Rp 0</span></div>${racikanStep < 4 ? `<button onclick="racikanStep++; navigateTo('racikan')" class="w-full bg-brand-hunter-green text-white py-3 rounded-lg font-bold">Next</button>` : `<button onclick="finalizeRacikan()" class="w-full bg-brand-hunter-green text-white py-3 rounded-lg font-bold">Pay Now</button>`}</div></div>`;
        }
        
        // --- PAYMENT PAGE (A6.2) ---
        function paymentPage() {
             const total = subtotal + (deliveryFee > 0 ? deliveryFee : 0);
            return `
                <div class="p-4 bg-brand-bg min-h-screen">
                    <div class="flex items-center mb-4"><button onclick="navigateTo('cart')" class="mr-4"><i class="ph-arrow-left text-2xl text-brand-dark-green"></i></button><h2 class="font-bold text-xl text-brand-dark-green">Payment</h2></div>
                    <div class="bg-white rounded-lg shadow p-4">
                        <h3 class="font-bold mb-3 text-brand-cafe-noir">Payment Method</h3>
                        <div class="space-y-3">
                            <label class="flex items-center justify-between p-3 border rounded-lg"><div class="flex items-center gap-3"><img src="https://placehold.co/40x40/000000/FFFFFF?text=QRIS" class="w-10 h-10 rounded-md"/><span class="text-brand-cafe-noir">QRIS</span></div><input type="radio" name="payment" checked class="h-5 w-5 text-brand-hunter-green focus:ring-brand-hunter-green"></label>
                            <label class="flex items-center justify-between p-3 border rounded-lg"><div class="flex items-center gap-3"><img src="https://placehold.co/40x40/10b981/FFFFFF?text=E" class="w-10 h-10 rounded-md"/><span class="text-brand-cafe-noir">E-Wallet</span></div><input type="radio" name="payment" class="h-5 w-5 text-brand-hunter-green focus:ring-brand-hunter-green"></label>
                        </div>
                    </div>
                    <div class="fixed bottom-16 max-w-sm w-full p-4 bg-white border-t"><button onclick="finalizeOrder()" class="w-full bg-brand-hunter-green text-white py-3 rounded-lg font-bold">Pay Rp ${total.toLocaleString('id-ID')}</button></div>
                </div>
            `;
        }
        
        // --- BOT PAGE ---
        function botPage() {
             return `
                <div class="h-screen flex flex-col bg-brand-bg">
                    <div class="p-4 bg-white shadow-md z-10">
                        <div class="flex items-center">
                            <button onclick="navigateTo('home')" class="mr-4"><i class="ph-arrow-left text-2xl text-brand-dark-green"></i></button>
                            <img src="https://placehold.co/40x40/4C6444/ffffff?text=M" class="w-10 h-10 rounded-full mr-3">
                            <div>
                                <h2 class="font-bold text-lg text-brand-dark-green">Konsul Si Mbok</h2>
                                <p class="text-sm text-brand-hunter-green">Online</p>
                            </div>
                        </div>
                    </div>

                    <div id="chat-container" class="flex-1 p-4 overflow-y-auto">
                        <div class="space-y-4">
                            <div class="flex justify-start">
                                <div class="bg-white rounded-lg p-3 max-w-xs shadow-sm">
                                    <p class="text-brand-cafe-noir">Sugeng Rawuh, Si Mbok is here. How do you feel?</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-white border-t">
                        <div class="flex items-center">
                            <input type="text" id="chat-input" placeholder="Type your message..." class="w-full border rounded-full py-2 px-4 text-brand-cafe-noir" onkeydown="if(event.key==='Enter') sendChatMessage()">
                            <button onclick="sendChatMessage()" class="ml-3 text-brand-hunter-green"><i class="ph-paper-plane-tilt-fill text-2xl"></i></button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- ROUTING & UTILITY FUNCTIONS for CART PAGE ---
        function updateCartSummary() {
            subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const deliveryFeeEl = document.getElementById('delivery-fee');
            const subtotalEl = document.getElementById('subtotal');
            const totalEl = document.getElementById('total-price');
            const paymentBtn = document.getElementById('payment-btn');
            if (deliveryFeeEl) deliveryFeeEl.innerText = `Rp ${deliveryFee < 0 ? 'N/A' : deliveryFee.toLocaleString('id-ID')}`;
            if (subtotalEl) subtotalEl.innerText = `Rp ${subtotal.toLocaleString('id-ID')}`;
            if (totalEl) totalEl.innerText = `Rp ${(subtotal + (deliveryFee > 0 ? deliveryFee : 0)).toLocaleString('id-ID')}`;
            if (paymentBtn) {
                if (deliveryFee < 0) { paymentBtn.disabled = true; paymentBtn.classList.add('bg-gray-400', 'cursor-not-allowed'); paymentBtn.classList.remove('bg-brand-hunter-green'); } 
                else { paymentBtn.disabled = false; paymentBtn.classList.remove('bg-gray-400', 'cursor-not-allowed'); paymentBtn.classList.add('bg-brand-hunter-green'); }
            }
        }
        window.changeCartQuantity = (index, amount) => {
            if (cart[index].quantity + amount >= 1) { cart[index].quantity += amount; } else { cart.splice(index, 1); }
            document.getElementById('cart-items-container').innerHTML = renderCartItems();
            updateCartSummary();
            updateFloatingCart();
        };
        window.selectDeliveryType = (type) => {
            deliveryType = type;
            if (type === 'pickup') { deliveryFee = 0; deliveryAddress = null; } 
            else { deliveryFee = deliveryAddress ? deliveryFee : -1; }
            navigateTo('cart');
        };
        window.searchAddress = (query) => {
            const suggestionsEl = document.getElementById('address-suggestions');
            if (!query) { suggestionsEl.innerHTML = ''; return; }
            const filtered = mockAddresses.filter(a => a.address.toLowerCase().includes(query.toLowerCase()));
            suggestionsEl.innerHTML = filtered.map((addr, index) => `<div class="p-2 cursor-pointer hover:bg-gray-100" onclick="selectAddress(${mockAddresses.findIndex(a => a.address === addr.address)})">${addr.address}</div>`).join('');
        };
        window.selectAddress = (index) => {
            deliveryAddress = mockAddresses[index];
            document.getElementById('address-input').value = deliveryAddress.address;
            document.getElementById('address-suggestions').innerHTML = '';
            if (deliveryAddress.distance < 5) { deliveryFee = 0; } 
            else if (deliveryAddress.distance <= 15) { deliveryFee = 10000; } 
            else { deliveryFee = -1; showCustomAlert('Sorry, this address is outside our 15km delivery range.'); }
            updateCartSummary();
        };
        function renderCartItems() {
             return cart.map((item, index) => `<div class="bg-white p-3 rounded-lg shadow-sm"><div class="flex justify-between items-start"><div><p class="font-semibold text-brand-cafe-noir">${item.name}</p><p class="text-brand-umber text-sm">Rp ${item.price.toLocaleString('id-ID')}</p><div class="text-xs text-gray-500 mt-1">${(item.options || []).map(opt => `<span>${opt.value}</span>`).join(', ')}</div></div><div class="flex items-center gap-3"><button onclick="changeCartQuantity(${index}, -1)" class="bg-gray-200 rounded-md w-6 h-6 flex-shrink-0">-</button><span class="min-w-[24px] text-center">${item.quantity}</span><button onclick="changeCartQuantity(${index}, 1)" class="bg-gray-200 rounded-md w-6 h-6 flex-shrink-0">+</button></div></div></div>`).join('');
        }
        
        window.sendChatMessage = () => {
            const input = document.getElementById('chat-input');
            const chatContainer = document.getElementById('chat-container').querySelector('.space-y-4');
            const message = input.value.trim();

            if (message) {
                const userMessageEl = document.createElement('div');
                userMessageEl.className = 'flex justify-end';
                userMessageEl.innerHTML = `<div class="bg-brand-hunter-green text-white rounded-lg p-3 max-w-xs shadow-sm"><p>${message}</p></div>`;
                chatContainer.appendChild(userMessageEl);

                input.value = '';
                chatContainer.parentElement.scrollTop = chatContainer.parentElement.scrollHeight;

                setTimeout(() => {
                    const botMessageEl = document.createElement('div');
                    botMessageEl.className = 'flex justify-start';
                    let botResponse = "Maaf, Si Mbok kurang paham. Coba jelaskan keluhan lain.";
                    if (message.toLowerCase().includes('pusing') || message.toLowerCase().includes('sakit kepala')) {
                        botResponse = "Untuk pusing, Jahe Wangi hangat bisa membantu melancarkan peredaran darah. Apakah Anda mau resepnya disimpan?";
                    } else if (message.toLowerCase().includes('capek') || message.toLowerCase().includes('lelah')) {
                        botResponse = "Kalau badan terasa lelah, Wedang Secang bisa membantu menyegarkan kembali. Mau resepnya disimpan?";
                    }
                    
                    botMessageEl.innerHTML = `<div class="bg-white rounded-lg p-3 max-w-xs shadow-sm"><p class="text-brand-cafe-noir">${botResponse}</p></div>`;
                    chatContainer.appendChild(botMessageEl);
                    chatContainer.parentElement.scrollTop = chatContainer.parentElement.scrollHeight;
                }, 1500);
            }
        };

        function navigateTo(page, params = null) {
            mainContent.innerHTML = ''; 
            window.scrollTo(0, 0);
            
            const floatingCart = document.getElementById('floating-cart-bar');
            if (['home', 'category', 'product'].includes(page)) {
                updateFloatingCart();
            } else {
                floatingCart.classList.add('hidden');
            }

            switch (page) {
                case 'home': mainContent.innerHTML = homePage(); break;
                case 'category': mainContent.innerHTML = categoryPage(params); break;
                case 'product': mainContent.innerHTML = productPage(params); break;
                case 'cart': mainContent.innerHTML = cartPage(); break;
                case 'payment': mainContent.innerHTML = paymentPage(); break;
                case 'orderHistory': mainContent.innerHTML = orderHistoryPage(); break;
                case 'racikan': mainContent.innerHTML = racikanPage(); break;
                case 'bot': mainContent.innerHTML = botPage(); break;
                case 'voucher': case 'account': case 'recipe':
                    mainContent.innerHTML = `<div class="p-8 text-center bg-brand-bg min-h-screen"><h1 class="text-2xl font-bold text-brand-dark-green">${page.charAt(0).toUpperCase() + page.slice(1)} Page</h1><p class="text-brand-cafe-noir">This page is under construction.</p><button onclick="navigateTo('home')" class="mt-4 bg-brand-hunter-green text-white px-4 py-2 rounded-lg">Go Home</button></div>`;
                    break;
                default: mainContent.innerHTML = homePage();
            }
        }

        // Initial load
        racikanStep = 1;
        updateFloatingCart();
        navigateTo('home');

    </script>

</body>
</html>
