<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meramu - Modern Jamu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        :root {
            --brand-deep-brown: #8B4411; --brand-brown: #AE6E4E; --brand-light-brown: #CC9767;
            --brand-beige: #C7AD7F; --brand-light-beige: #F5F5DD; --brand-muted-brown: #A57A5A;
        }
        .bg-brand-deep-brown { background-color: var(--brand-deep-brown); }
        .bg-brand-brown { background-color: var(--brand-brown); }
        .bg-brand-light-brown { background-color: var(--brand-light-brown); }
        .bg-brand-beige { background-color: var(--brand-beige); }
        .text-brand-deep-brown { color: var(--brand-deep-brown); }
        .border-brand-deep-brown { border-color: var(--brand-deep-brown); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .screen { display: none; }
        .screen.active { display: block; }
        .chat-bubble-bot { background-color: #f1f1f1; align-self: flex-start; }
        .chat-bubble-user { background-color: var(--brand-beige); color: white; align-self: flex-end; }
        .racikan-step { display: none; }
        .racikan-step.active { display: block; }
    </style>
</head>
<body class="bg-brand-light-beige">

    <div id="app-container" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl flex flex-col relative">
        
        <main class="flex-grow pb-20 overflow-y-auto">
            <!-- Home Screen (A1) -->
            <div id="home-screen" class="screen active p-6">
                <header class="flex justify-between items-center mb-6">
                    <div><h1 class="text-2xl font-bold text-brand-deep-brown">Hi, User!</h1></div>
                    <div class="bg-brand-beige text-white font-bold py-2 px-4 rounded-full shadow-md">0 pts</div>
                </header>
                <div class="bg-brand-light-brown text-white p-6 rounded-2xl shadow-lg mb-8 h-32 flex items-center justify-center">
                    <h2 class="text-2xl font-bold">CAMPAIGN</h2>
                </div>
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-brand-deep-brown mb-4">Category</h3>
                    <div class="grid grid-cols-5 gap-2 text-center">
                        <div class="category-btn" data-category="panas"><div class="bg-brand-beige p-3 rounded-2xl shadow-sm"><i data-lucide="coffee" class="mx-auto text-white"></i></div><span class="text-xs mt-2 block text-brand-muted-brown">Panas</span></div>
                        <div class="category-btn" data-category="dingin"><div class="bg-brand-beige p-3 rounded-2xl shadow-sm"><i data-lucide="snowflake" class="mx-auto text-white"></i></div><span class="text-xs mt-2 block text-brand-muted-brown">Dingin</span></div>
                        <div class="category-btn" data-category="kudapan"><div class="bg-brand-beige p-3 rounded-2xl shadow-sm"><i data-lucide="croissant" class="mx-auto text-white"></i></div><span class="text-xs mt-2 block text-brand-muted-brown">Kudapan</span></div>
                        <div class="category-btn" data-category="recipe"><div class="bg-brand-beige p-3 rounded-2xl shadow-sm"><i data-lucide="book-marked" class="mx-auto text-white"></i></div><span class="text-xs mt-2 block text-brand-muted-brown">Resep</span></div>
                        <div id="konsul-btn"><div class="bg-brand-deep-brown p-3 rounded-2xl shadow-sm"><i data-lucide="bot" class="mx-auto text-white"></i></div><span class="text-xs mt-2 block text-brand-muted-brown">Bot</span></div>
                    </div>
                </div>
                <div class="mt-4">
                    <h3 class="text-xl font-bold text-brand-deep-brown mb-4">Popular!</h3>
                    <div id="popular-items" class="grid grid-cols-3 gap-4"></div>
                </div>
            </div>

            <!-- Category Screen (A2) -->
            <div id="category-screen" class="screen">
                <header class="p-4 flex items-center gap-4 border-b"><button class="nav-btn" data-target="home-screen"><i data-lucide="arrow-left"></i></button><h2 id="category-title" class="text-xl font-bold text-brand-deep-brown">Category</h2></header>
                <div id="category-items-grid" class="p-4 grid grid-cols-2 gap-4"></div>
            </div>

            <!-- Product Detail Screen (A3) -->
            <div id="product-detail-screen" class="screen flex flex-col h-full">
                 <header class="p-4 flex items-center gap-4 border-b sticky top-0 bg-white z-10"><button id="back-to-category-btn"><i data-lucide="arrow-left"></i></button><h2 class="text-xl font-bold text-brand-deep-brown">Details</h2></header>
                <div id="product-details-content" class="p-6 flex-grow overflow-y-auto"></div>
                <footer class="p-4 border-t bg-white z-10 flex justify-between items-center">
                    <div><p class="text-sm text-gray-500">Total Price</p><p id="product-total-price" class="text-2xl font-bold text-brand-deep-brown">Rp 0</p></div>
                    <button id="add-to-cart-btn" class="bg-brand-deep-brown text-white font-bold py-3 px-8 rounded-full shadow-lg">Add to Cart</button>
                </footer>
            </div>
            
            <!-- Cart Screen (A4/A5) -->
            <div id="cart-screen" class="screen flex flex-col h-full">
                <header class="p-4 flex items-center gap-4 border-b"><button class="nav-btn" data-target="home-screen"><i data-lucide="arrow-left"></i></button><h2 class="text-xl font-bold text-brand-deep-brown">Your Order</h2></header>
                <div id="cart-items-container" class="p-4 flex-grow overflow-y-auto"></div>
                <div class="p-4 mt-auto border-t">
                    <div class="flex justify-between items-center mb-4"><span class="text-lg text-gray-600">Total</span><span id="cart-total-price" class="text-2xl font-bold text-brand-deep-brown">Rp 0</span></div>
                    <button class="bg-brand-deep-brown text-white w-full py-3 rounded-full font-bold shadow-lg">Pay Now</button>
                </div>
            </div>

            <!-- Racikan Sendiri Screen (B1/B2/B3) -->
            <div id="racikan-screen" class="screen flex flex-col h-full">
                <header class="p-4 flex items-center gap-4 border-b"><button id="racikan-back-btn"><i data-lucide="arrow-left"></i></button><h2 class="text-xl font-bold text-brand-deep-brown">Jamu Racikan Sendiri</h2></header>
                <div class="p-6 flex-grow overflow-y-auto">
                    <div id="racikan-step-1" class="racikan-step active space-y-6">
                        <div><label class="font-bold text-brand-muted-brown">Temperature</label><div id="racikan-temp" class="flex gap-2 mt-2"><button data-value="hot" data-price="3000" class="racikan-option flex-1 p-3 border rounded-lg">Hot</button><button data-value="iced" data-price="0" class="racikan-option flex-1 p-3 border rounded-lg">Iced</button></div></div>
                        <div><label class="font-bold text-brand-muted-brown">Base</label><div id="racikan-base" class="grid grid-cols-3 gap-2 mt-2"><button data-value="water" data-price="0" class="racikan-option p-3 border rounded-lg">Water</button><button data-value="teh" data-price="2000" class="racikan-option p-3 border rounded-lg">Teh</button><button data-value="kopi" data-price="5000" class="racikan-option p-3 border rounded-lg">Kopi</button></div></div>
                    </div>
                    <div id="racikan-step-2" class="racikan-step space-y-6">
                        <div><label class="font-bold text-brand-muted-brown">Herbs (Choose up to 3)</label><div id="racikan-herbs" class="grid grid-cols-3 gap-2 mt-2"></div></div>
                    </div>
                    <div id="racikan-step-3" class="racikan-step space-y-6">
                        <div><label class="font-bold text-brand-muted-brown">Sugar</label><div id="racikan-sugar" class="grid grid-cols-2 gap-2 mt-2"><button data-value="no_sugar" data-price="0" class="racikan-option p-3 border rounded-lg">No Sugar</button><button data-value="white_sugar" data-price="0" class="racikan-option p-3 border rounded-lg">White Sugar</button><button data-value="palm_sugar" data-price="0" class="racikan-option p-3 border rounded-lg">Palm Sugar</button><button data-value="diabetic_sugar" data-price="5000" class="racikan-option p-3 border rounded-lg">Diabetic Sugar</button></div></div>
                        <div><label class="font-bold text-brand-muted-brown">Name your Jamu (Optional)</label><input type="text" id="racikan-name" placeholder="My Awesome Jamu" class="w-full p-3 border rounded-lg mt-2"></div>
                    </div>
                </div>
                <footer class="p-4 border-t bg-white z-10 flex justify-between items-center">
                    <div><p class="text-sm text-gray-500">Total Price</p><p id="racikan-total-price" class="text-2xl font-bold text-brand-deep-brown">Rp 0</p></div>
                    <button id="racikan-next-btn" class="bg-brand-deep-brown text-white font-bold py-3 px-8 rounded-full shadow-lg">Next</button>
                </footer>
            </div>
        </main>

        <!-- Bottom Navigation Bar -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t-2 border-brand-light-beige shadow-[0_-10px_30px_-15px_rgba(0,0,0,0.1)] rounded-t-2xl z-20">
            <div class="flex justify-around items-center h-16">
                <button class="nav-btn text-brand-deep-brown" data-target="home-screen"><i data-lucide="home"></i><span class="text-xs">Home</span></button>
                <button class="nav-btn text-brand-muted-brown" data-target="voucher-screen"><i data-lucide="ticket"></i><span class="text-xs">Voucher</span></button>
                <button class="nav-btn -mt-8" data-target="racikan-screen"><div class="bg-brand-deep-brown text-white rounded-full p-4 shadow-xl border-4 border-white"><i data-lucide="flask-conical"></i></div></button>
                <button class="nav-btn text-brand-muted-brown" data-target="cart-screen"><div class="relative"><i data-lucide="shopping-cart"></i><span id="cart-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center hidden">0</span></div><span class="text-xs">Order</span></button>
                <button class="nav-btn text-brand-muted-brown" data-target="account-screen"><i data-lucide="user"></i><span class="text-xs">Account</span></button>
            </div>
        </nav>

        <!-- Konsul Si Mbok Chat Modal -->
        <div id="chat-modal" class="absolute inset-0 bg-white z-30 flex-col h-full" style="display: none;">
            <header class="p-4 flex items-center gap-4 border-b"><button id="close-chat-btn"><i data-lucide="x"></i></button><h2 class="text-xl font-bold text-brand-deep-brown">Konsul Si Mbok</h2></header>
            <div id="chat-messages" class="flex-grow p-4 space-y-2 overflow-y-auto flex flex-col"></div>
            <footer class="p-4 border-t bg-white">
                <div id="chat-input-container" class="flex items-center gap-2"><input type="text" id="chat-input" placeholder="Tell me how you feel..." class="w-full p-2 border rounded-full"><button id="chat-send-btn" class="bg-brand-deep-brown text-white p-2 rounded-full"><i data-lucide="send"></i></button></div>
                <div id="chat-options-container" class="hidden flex-col gap-2"></div>
            </footer>
        </div>

    </div>

    <script>
        const db = {
            products: [
                { id: 1, name: 'Jahe Wangi', category: 'panas', price: 10000, popular: true, img: 'https://placehold.co/300x300/AE6E4E/F5F5DD?text=Jahe+Wangi' },
                { id: 2, name: 'Kopi Rempah', category: 'panas', price: 12000, popular: false, img: 'https://placehold.co/300x300/AE6E4E/F5F5DD?text=Kopi+Rempah' },
                { id: 3, name: 'Kunir Asem', category: 'dingin', price: 8000, popular: true, img: 'https://placehold.co/300x300/CC9767/F5F5DD?text=Kunir+Asem' },
                { id: 4, name: 'Beras Kencur', category: 'dingin', price: 8000, popular: false, img: 'https://placehold.co/300x300/CC9767/F5F5DD?text=Beras+Kencur' },
                { id: 5, name: 'Es Kopi Kayu Manis', category: 'dingin', price: 15000, popular: true, img: 'https://placehold.co/300x300/CC9767/F5F5DD?text=Es+Kopi' },
                { id: 6, name: 'Panada (isi 3)', category: 'kudapan', price: 15000, popular: true, img: 'https://placehold.co/300x300/A57A5A/F5F5DD?text=Panada', description: "A deep-fried, crescent-shaped savory bread from Manado filled with spicy shredded tuna. A single portion contains 3 pieces." },
                { id: 7, name: 'Timus Ubi Ungu', category: 'kudapan', price: 12000, popular: false, img: 'https://placehold.co/300x300/A57A5A/F5F5DD?text=Timus', description: "A vibrant purple, chewy, and sweet deep-fried snack made from mashed purple sweet potatoes. A single portion contains 3 pieces." },
                { id: 8, name: 'Pisang Epe', category: 'kudapan', price: 10000, popular: false, img: 'https://placehold.co/300x300/A57A5A/F5F5DD?text=Pisang+Epe', description: "A street food from Makassar featuring grilled, flattened bananas served with a sweet palm sugar sauce." },
            ],
            herbs: [
                { name: 'Jahe', price: 0 }, { name: 'Kencur', price: 2000 }, { name: 'Kunyit', price: 5000 }, 
                { name: 'Temulawak', price: 3000 }, { name: 'Cengkeh', price: 7000 }, { name: 'Sereh', price: 7000 },
                { name: 'Kayu Manis', price: 0 }, { name: 'Secang', price: 0 }, { name: 'Sambiloto', price: 0 }
            ]
        };

        let cart = [], currentProduct = null, currentCategory = null, racikanState = {}, chatState = 'START', racikanCurrentStep = 1;
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);

        const formatCurrency = (amount) => `Rp ${amount.toLocaleString('id-ID')}`;

        const navigateTo = (screenId) => {
            $$('.screen').forEach(s => s.classList.toggle('active', s.id === screenId));
            if (screenId === 'racikan-screen') resetRacikan();
            $$('.nav-btn').forEach(btn => {
                const target = btn.dataset.target;
                const method = target === screenId ? 'add' : 'remove';
                btn.classList[method]('text-brand-deep-brown');
                btn.classList[target !== screenId ? 'add' : 'remove']('text-brand-muted-brown');
            });
        };

        const renderProducts = (products, container, template) => {
            container.innerHTML = products.map(template).join('');
        };

        const popularTemplate = product => `
            <div class="product-card text-center" data-product-id="${product.id}">
                <img src="${product.img}" alt="${product.name}" class="w-full h-24 object-cover rounded-2xl mb-2">
                <h4 class="font-semibold text-sm text-brand-deep-brown truncate">${product.name}</h4>
                <p class="text-xs text-brand-muted-brown">${formatCurrency(product.price)}</p>
            </div>`;

        const categoryTemplate = product => `
            <div class="product-card" data-product-id="${product.id}">
                <img src="${product.img}" alt="${product.name}" class="w-full h-32 object-cover rounded-2xl mb-2">
                <h4 class="font-semibold text-brand-deep-brown truncate">${product.name}</h4>
                <p class="text-sm text-brand-muted-brown">${formatCurrency(product.price)}</p>
            </div>`;

        const renderCategoryItems = (category) => {
            currentCategory = category;
            const categoryProducts = db.products.filter(p => p.category === category);
            $('#category-title').textContent = category.charAt(0).toUpperCase() + category.slice(1);
            renderProducts(categoryProducts, $('#category-items-grid'), categoryTemplate);
            navigateTo('category-screen');
        };

        const updateProductPrice = () => {
            if (!currentProduct) return;
            let total = currentProduct.price + Object.values(currentProduct.options).reduce((sum, opt) => sum + opt.price, 0);
            $('#product-total-price').textContent = formatCurrency(total);
        };

        const renderProductDetails = (productId) => {
            const product = db.products.find(p => p.id === parseInt(productId));
            if (!product) return;
            currentProduct = { ...product, options: {}, quantity: 1 };
            
            let optionsHtml = (product.category === 'panas' || product.category === 'dingin') ? `
                <div class="space-y-4">
                    ${product.category === 'dingin' ? `<div><h4 class="font-bold text-brand-muted-brown mb-2">Size</h4><div class="flex gap-2" data-option-key="size"><button class="option-btn active" data-value="regular" data-price="0">Regular</button><button class="option-btn" data-value="extra" data-price="5000">Extra (+${formatCurrency(5000)})</button></div></div>` : ''}
                    <div><h4 class="font-bold text-brand-muted-brown mb-2">Sugar</h4><div class="flex gap-2" data-option-key="sugar"><button class="option-btn active" data-value="normal" data-price="0">Normal</button><button class="option-btn" data-value="diabetic" data-price="5000">Diabetic (+${formatCurrency(5000)})</button></div></div>
                    <div><h4 class="font-bold text-brand-muted-brown mb-2">Sugar Level</h4><div class="flex gap-2" data-option-key="sugar_level"><button class="option-btn active" data-value="normal" data-price="0">Normal</button><button class="option-btn" data-value="less" data-price="0">Less</button><button class="option-btn" data-value="no_sugar" data-price="0">No Sugar</button></div></div>
                </div>` : '';

            $('#product-details-content').innerHTML = `
                <img src="${product.img}" alt="${product.name}" class="w-full h-60 object-cover rounded-3xl mb-4">
                <div class="px-1">
                    <h2 class="text-3xl font-bold text-brand-deep-brown mb-2">${product.name}</h2>
                    <p class="text-xl text-brand-muted-brown mb-4">${formatCurrency(product.price)}</p>
                    ${product.description ? `<p class="text-brand-muted-brown mb-6">${product.description}</p>` : ''}
                    ${optionsHtml}
                </div>`;
            updateProductPrice();
            navigateTo('product-detail-screen');
        };

        const updateCart = () => {
            const container = $('#cart-items-container');
            if (cart.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">Your cart is empty.</p>`;
            } else {
                container.innerHTML = cart.map((item, index) => `
                    <div class="flex items-center gap-4 mb-4 p-2 rounded-lg border">
                        <img src="${item.img}" class="w-16 h-16 object-cover rounded-md">
                        <div class="flex-grow">
                            <p class="font-bold text-brand-deep-brown">${item.name}</p>
                            <p class="text-sm text-gray-500">${item.options || formatCurrency(item.price)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="quantity-btn p-1" data-index="${index}" data-change="-1"><i data-lucide="minus" class="w-4 h-4"></i></button>
                            <span>${item.quantity}</span>
                            <button class="quantity-btn p-1" data-index="${index}" data-change="1"><i data-lucide="plus" class="w-4 h-4"></i></button>
                        </div>
                    </div>`).join('');
            }
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            $('#cart-total-price').textContent = formatCurrency(total);
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            $('#cart-badge').textContent = totalItems;
            $('#cart-badge').classList.toggle('hidden', totalItems === 0);
            lucide.createIcons();
        };
        
        const resetRacikan = () => {
            racikanCurrentStep = 1;
            racikanState = { temp: null, base: null, herbs: [], sugar: null, name: '' };
            $$('#racikan-screen .racikan-option.active').forEach(el => el.classList.remove('active', 'border-brand-deep-brown', 'bg-brand-beige', 'text-white'));
            $('#racikan-name').value = '';
            updateRacikanStep();
            updateRacikanPrice();
        };

        const updateRacikanPrice = () => {
            let total = (racikanState.temp?.price || 0) + (racikanState.base?.price || 0) + (racikanState.sugar?.price || 0) + racikanState.herbs.reduce((sum, h) => sum + h.price, 0);
            $('#racikan-total-price').textContent = formatCurrency(total);
        };

        const updateRacikanStep = () => {
            $$('.racikan-step').forEach(step => step.classList.toggle('active', parseInt(step.id.split('-')[2]) === racikanCurrentStep));
            $('#racikan-next-btn').textContent = racikanCurrentStep === 3 ? 'Add to Cart' : 'Next';
        };

        const handleRacikanNext = () => {
            if (racikanCurrentStep < 3) {
                racikanCurrentStep++;
                updateRacikanStep();
            } else {
                const finalPrice = (racikanState.temp?.price || 0) + (racikanState.base?.price || 0) + (racikanState.sugar?.price || 0) + racikanState.herbs.reduce((sum, h) => sum + h.price, 0);
                const optionsDesc = [racikanState.temp?.value, racikanState.base?.value, ...racikanState.herbs.map(h => h.value), racikanState.sugar?.value].filter(Boolean).join(', ');
                const jamuName = $('#racikan-name').value.trim() || "Jamu Racikan Sendiri";
                cart.push({ id: `racikan_${Date.now()}`, name: jamuName, img: 'https://placehold.co/300x300/8B4411/F5F5DD?text=Racikan', price: finalPrice, quantity: 1, options: optionsDesc });
                updateCart();
                navigateTo('cart-screen');
            }
        };

        const chatLogic = {
            'AWAITING_FEELING': (response) => {
                addChatMessage(response, 'user');
                setTimeout(() => {
                    addChatMessage('Diagnosing...', 'bot');
                    setTimeout(() => {
                        addChatMessage("Here's your health diagnosis... a recipe of Kunyit and Jahe would be good for you.", 'bot');
                        addChatMessage('Do you wish to save the recipe?', 'bot');
                        chatState = 'AWAITING_SAVE_RECIPE';
                        showChatOptions([{text: 'Yes', value: 'yes'}, {text: 'No', value: 'no'}]);
                    }, 1500);
                }, 1000);
            },
            'AWAITING_SAVE_RECIPE': (response) => {
                addChatMessage(response === 'yes' ? 'Yes' : 'No', 'user');
                hideChatOptions();
                if (response === 'yes') {
                    addChatMessage(`Saved! Here's your recipe number: #${Math.floor(1000 + Math.random() * 9000)}`, 'bot');
                }
                setTimeout(() => {
                    addChatMessage('End Chat?', 'bot');
                    chatState = 'AWAITING_END_CHAT';
                    showChatOptions([{text: 'Yes', value: 'yes'}, {text: 'No', value: 'no'}]);
                }, 1000);
            },
            'AWAITING_END_CHAT': (response) => {
                addChatMessage(response === 'yes' ? 'Yes' : 'No', 'user');
                hideChatOptions();
                if (response === 'yes') $('#close-chat-btn').click(); else startChat();
            }
        };

        const addChatMessage = (message, sender) => {
            const bubble = document.createElement('div');
            bubble.textContent = message;
            bubble.className = `p-3 rounded-2xl max-w-xs break-words chat-bubble-${sender}`;
            $('#chat-messages').appendChild(bubble);
            $('#chat-messages').scrollTop = $('#chat-messages').scrollHeight;
        };
        const showChatOptions = (options) => {
            $('#chat-input-container').classList.add('hidden');
            const optsContainer = $('#chat-options-container');
            optsContainer.classList.remove('hidden');
            optsContainer.innerHTML = options.map(opt => `<button class="chat-option-btn w-full p-2 rounded-lg bg-brand-beige text-white" data-value="${opt.value}">${opt.text}</button>`).join('');
        };
        const hideChatOptions = () => {
            $('#chat-input-container').classList.remove('hidden');
            $('#chat-options-container').classList.add('hidden');
        };
        const startChat = () => {
            chatState = 'AWAITING_FEELING';
            $('#chat-messages').innerHTML = '';
            hideChatOptions();
            addChatMessage('Sugeng Rawuh, Si Mbok is here. How do you feel?', 'bot');
        };

        document.addEventListener('DOMContentLoaded', () => {
            renderProducts(db.products.filter(p => p.popular), $('#popular-items'), popularTemplate);
            $('#racikan-herbs').innerHTML = db.herbs.map(herb => `<button data-value="${herb.name}" data-price="${herb.price}" class="racikan-option p-2 border rounded-lg text-sm">${herb.name}</button>`).join('');
            resetRacikan();
            lucide.createIcons();

            document.body.addEventListener('click', e => {
                const target = e.target;
                const productCard = target.closest('.product-card');
                const categoryBtn = target.closest('.category-btn');
                const navBtn = target.closest('.nav-btn');
                const optionBtn = target.closest('.option-btn');
                const quantityBtn = target.closest('.quantity-btn');
                const racikanOption = target.closest('.racikan-option');

                if (productCard) renderProductDetails(productCard.dataset.productId);
                if (categoryBtn) renderCategoryItems(categoryBtn.dataset.category);
                if (navBtn) navigateTo(navBtn.dataset.target);
                if (target.closest('#konsul-btn')) { $('#chat-modal').style.display = 'flex'; startChat(); }
                if (target.closest('#close-chat-btn')) $('#chat-modal').style.display = 'none';
                if (target.closest('#back-to-category-btn')) navigateTo(currentCategory ? 'category-screen' : 'home-screen');
                if (target.closest('#add-to-cart-btn')) {
                    let finalPrice = currentProduct.price + Object.values(currentProduct.options).reduce((sum, opt) => sum + opt.price, 0);
                    let optionsSummary = Object.values(currentProduct.options).map(o => o.value).join(', ');
                    const existing = cart.find(item => item.id === currentProduct.id && item.options === optionsSummary);
                    if (existing) existing.quantity++;
                    else cart.push({ ...currentProduct, price: finalPrice, quantity: 1, options: optionsSummary });
                    updateCart(); navigateTo('cart-screen');
                }
                if (quantityBtn) {
                    const index = parseInt(quantityBtn.dataset.index);
                    cart[index].quantity += parseInt(quantityBtn.dataset.change);
                    if (cart[index].quantity <= 0) cart.splice(index, 1);
                    updateCart();
                }
                if (optionBtn) {
                    const parent = optionBtn.parentElement;
                    parent.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('active'));
                    optionBtn.classList.add('active');
                    currentProduct.options[parent.dataset.optionKey] = { value: optionBtn.dataset.value, price: parseInt(optionBtn.dataset.price) };
                    updateProductPrice();
                }
                if (racikanOption) {
                    const parent = racikanOption.parentElement;
                    const value = racikanOption.dataset.value;
                    const price = parseInt(racikanOption.dataset.price);
                    if (parent.id === 'racikan-herbs') {
                        const isSelected = racikanOption.classList.toggle('active');
                        if (isSelected && racikanState.herbs.length < 3) racikanState.herbs.push({ value, price });
                        else if (isSelected) racikanOption.classList.remove('active');
                        else racikanState.herbs = racikanState.herbs.filter(h => h.value !== value);
                    } else {
                        parent.querySelectorAll('.racikan-option').forEach(btn => btn.classList.remove('active', 'border-brand-deep-brown', 'bg-brand-beige', 'text-white'));
                        if (parent.id === 'racikan-temp') racikanState.temp = { value, price };
                        if (parent.id === 'racikan-base') racikanState.base = { value, price };
                        if (parent.id === 'racikan-sugar') racikanState.sugar = { value, price };
                    }
                    racikanOption.classList.toggle('active', racikanOption.classList.contains('active') || parent.id !== 'racikan-herbs');
                    racikanOption.classList.toggle('border-brand-deep-brown', racikanOption.classList.contains('active'));
                    racikanOption.classList.toggle('bg-brand-beige', racikanOption.classList.contains('active'));
                    racikanOption.classList.toggle('text-white', racikanOption.classList.contains('active'));
                    updateRacikanPrice();
                }
                if (target.closest('#racikan-next-btn')) handleRacikanNext();
                if (target.closest('#racikan-back-btn')) {
                    if (racikanCurrentStep > 1) { racikanCurrentStep--; updateRacikanStep(); } 
                    else navigateTo('home-screen');
                }
                if (target.closest('#chat-send-btn') && $('#chat-input').value.trim()) {
                    chatLogic[chatState]($('#chat-input').value.trim());
                    $('#chat-input').value = '';
                }
                if (target.closest('.chat-option-btn')) {
                    chatLogic[chatState](target.closest('.chat-option-btn').dataset.value);
                }
            });
            $('#chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                    chatLogic[chatState](e.target.value.trim());
                    e.target.value = '';
                }
            });
        });
    </script>
</body>
</html>
