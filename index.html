<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meramu Jamu</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS to hide scrollbars */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* Simple transition for screen visibility */
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="font-sans antialiased bg-white max-w-md mx-auto shadow-2xl relative min-h-screen">
        <div id="main-content" class="pb-24">
            <!-- Screens will be rendered here by JavaScript -->
        </div>

        <!-- Bottom Navigation Bar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 h-20 z-40 max-w-md mx-auto">
            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-200 h-16">
                <div class="flex justify-around h-full">
                    <button data-screen="home" class="nav-item flex flex-col items-center justify-center pt-2 transition-colors w-1/5">
                        <!-- Home Icon -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        <span class="text-xs font-semibold">Home</span>
                    </button>
                    <button data-screen="voucher" class="nav-item flex flex-col items-center justify-center pt-2 transition-colors w-1/5">
                        <!-- Voucher Icon -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path></svg>
                        <span class="text-xs font-semibold">Voucher</span>
                    </button>
                    <div class="w-1/5"></div> <!-- Placeholder for center button -->
                    <button data-screen="orders" class="nav-item flex flex-col items-center justify-center pt-2 transition-colors w-1/5">
                        <!-- Orders Icon -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                        <span class="text-xs font-semibold">Orders</span>
                    </button>
                    <button data-screen="account" class="nav-item flex flex-col items-center justify-center pt-2 transition-colors w-1/5">
                        <!-- Account Icon -->
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        <span class="text-xs font-semibold">Account</span>
                    </button>
                </div>
            </div>
            <div class="absolute bottom-4 left-1/2 -translate-x-1/2">
                <button data-screen="meramu" class="nav-item bg-amber-900 text-white w-20 h-20 rounded-full flex items-center justify-center shadow-2xl border-4 border-white">
                    <!-- Ramuan Icon -->
                    <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5 3a1 1 0 000 2c0 1.1.9 2 2 2h6a2 2 0 002-2 1 1 0 100-2H5z"></path><path fill-rule="evenodd" d="M3 8a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM5.05 11.636a1 1 0 01.707.293l2 2a1 1 0 01-1.414 1.414l-2-2a1 1 0 01.707-1.707zM14.95 11.636a1 1 0 01.707 1.707l-2 2a1 1 0 01-1.414-1.414l2-2a1 1 0 01.707-.293zM10 15a1 1 0 011 1v2a1 1 0 11-2 0v-2a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </nav>

        <!-- Product Modal -->
        <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
            <div id="product-modal-content" class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm">
                <!-- Modal content will be injected here -->
            </div>
        </div>
    </div>

    <script type="module">
        // --- MOCK DATA & CONSTANTS ---
        const POPULAR_PRODUCTS = [
            { id: 'item1', name: 'Bir Pletok', category: 'Hot Drinks', image: 'https://placehold.co/600x400/854d0e/ffffff?text=Bir+Pletok', price: 25000, type: 'drink' },
            { id: 'item2', name: 'Panada', category: 'Snacks', image: 'https://placehold.co/600x400/eab308/ffffff?text=Panada', price: 10000, type: 'snack' },
            { id: 'item3', name: 'Kunyit Asam', category: 'Hot Drinks', image: 'https://placehold.co/600x400/f59e0b/ffffff?text=Kunyit+Asam', price: 22000, type: 'drink' },
            { id: 'item4', name: 'Lemper Ayam', category: 'Snacks', image: 'https://placehold.co/600x400/78350f/ffffff?text=Lemper', price: 12000, type: 'snack_simple' },
        ];
        const REMPAH_OPTIONS = ["Ginger", "Turmeric", "Galangal", "Sappanwood", "Cinnamon", "Sugar", "Lime", "Cloves", "Nutmeg", "Javanese Ginger", "Lemongrass", "Cardamom"];
        const PRICES = { regular: 14000, xtra: 29000, diabeticSugar: 5000, adminFee: 1000, sambal: 500 };

        // --- APPLICATION STATE ---
        let state = {
            screen: 'home',
            cart: [],
            savedRecipes: [],
            transactionHistory: [],
            meramuOrder: { temp: 'Hot', size: 'Regular', ingredients: [], iceLevel: 'Normal Ice', sugar: 'White Sugar', name: '' },
            meramuStep: 1,
            botMessages: [{ from: 'bot', text: "How do you feel?" }],
            botStage: 'ask',
            botUserInput: '',
        };

        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const bottomNav = document.getElementById('bottom-nav');
        const productModal = document.getElementById('product-modal');
        const productModalContent = document.getElementById('product-modal-content');

        // --- HELPER FUNCTIONS ---
        const formatCurrency = (value) => `Rp ${value.toLocaleString('id-ID')}`;
        const getArrowIcon = () => `<svg class="w-6 h-6 text-amber-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>`;

        // --- STATE & NAVIGATION ---
        function navigateTo(screenName) {
            state.screen = screenName;
            renderApp();
        }

        function updateMeramuOrder(newValues) {
            state.meramuOrder = { ...state.meramuOrder, ...newValues };
        }

        // --- RENDERING LOGIC ---
        function renderApp() {
            // Clear previous content
            mainContent.innerHTML = '';
            
            // Show/hide bottom nav
            bottomNav.style.display = state.screen === 'meramu' ? 'none' : 'block';

            // Render the current screen
            switch (state.screen) {
                case 'home':
                    mainContent.innerHTML = renderHomeScreen();
                    addHomeScreenListeners();
                    break;
                case 'meramu':
                    renderMeramuFlow();
                    break;
                case 'cart':
                    mainContent.innerHTML = renderCartScreen();
                    addCartScreenListeners();
                    break;
                case 'bot':
                    mainContent.innerHTML = renderBotScreen();
                    addBotScreenListeners();
                    break;
                case 'recipe':
                    mainContent.innerHTML = renderRecipeScreen();
                    addRecipeScreenListeners();
                    break;
                case 'orders':
                    mainContent.innerHTML = renderOrdersScreen();
                    break;
                // Add other screens like voucher, account as needed
                default:
                    mainContent.innerHTML = renderHomeScreen();
                    addHomeScreenListeners();
            }
            updateNavActiveState();
        }

        function updateNavActiveState() {
            document.querySelectorAll('.nav-item').forEach(item => {
                const svg = item.querySelector('svg');
                const span = item.querySelector('span');
                if (item.dataset.screen === state.screen) {
                    svg?.classList.remove('text-gray-400');
                    svg?.classList.add('text-amber-800');
                    span?.classList.remove('text-gray-400');
                    span?.classList.add('text-amber-800');
                } else {
                    svg?.classList.remove('text-amber-800');
                    svg?.classList.add('text-gray-400');
                    span?.classList.remove('text-amber-800');
                    span?.classList.add('text-gray-400');
                }
            });
        }
        
        // --- SCREEN TEMPLATES & LISTENERS ---

        // HomeScreen
        function renderHomeScreen() {
            const productCards = POPULAR_PRODUCTS.map(item => `
                <div data-product-id="${item.id}" class="product-card bg-white rounded-xl shadow p-3 flex-shrink-0 w-40 cursor-pointer">
                    <img src="${item.image}" alt="${item.name}" class="w-full h-24 rounded-lg object-cover mb-3 pointer-events-none" />
                    <h4 class="font-bold text-amber-900 truncate pointer-events-none">${item.name}</h4>
                    <p class="font-bold text-amber-700 text-sm pointer-events-none">${formatCurrency(item.price)}</p>
                </div>
            `).join('');

            return `
                <div class="bg-orange-50 min-h-screen">
                    <header class="bg-amber-800 text-white p-5 rounded-b-3xl shadow-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h1 class="text-2xl font-bold tracking-wider">MERAMU</h1>
                            <div class="bg-white text-amber-800 font-bold px-4 py-1 rounded-full text-sm shadow-md">23 POIN</div>
                        </div>
                        <p class="text-lg font-light">Hi, Simbok!</p>
                    </header>
                    <div class="p-5">
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-amber-900 mb-3">Category</h3>
                            <div class="grid grid-cols-4 gap-3 text-center">
                                <button class="bg-white p-3 rounded-lg shadow"><span class="text-2xl">üî•</span><p class="font-semibold text-sm text-amber-800">Hot</p></button>
                                <button class="bg-white p-3 rounded-lg shadow"><span class="text-2xl">‚ùÑÔ∏è</span><p class="font-semibold text-sm text-amber-800">Ice</p></button>
                                <button class="bg-white p-3 rounded-lg shadow"><span class="text-2xl">ü•ê</span><p class="font-semibold text-sm text-amber-800">Food</p></button>
                                <button id="recipe-btn" class="bg-white p-3 rounded-lg shadow"><span class="text-2xl">üìú</span><p class="font-semibold text-sm text-amber-800">Recipe</p></button>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="text-xl font-bold text-amber-900">Popular Now!</h3>
                                <button id="konsul-btn" class="flex flex-col items-center text-center">
                                    <div class="w-14 h-14 bg-white rounded-full shadow-md flex items-center justify-center">
                                        <span class="text-3xl">ü§ñ</span>
                                    </div>
                                    <p class="text-xs font-semibold text-amber-800 mt-1">Konsul<br/>Si Mbok</p>
                                </button>
                            </div>
                            <div class="flex space-x-4 overflow-x-auto pb-4 -mx-5 px-5 scrollbar-hide">
                                ${productCards}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function addHomeScreenListeners() {
            document.getElementById('konsul-btn').addEventListener('click', () => navigateTo('bot'));
            document.getElementById('recipe-btn').addEventListener('click', () => navigateTo('recipe'));
            document.querySelectorAll('.product-card').forEach(card => {
                card.addEventListener('click', () => {
                    const productId = card.dataset.productId;
                    const product = POPULAR_PRODUCTS.find(p => p.id === productId);
                    if (product.type === 'snack_simple') {
                        addToCart(product);
                    } else {
                        openProductModal(product);
                    }
                });
            });
        }

        // Meramu Flow
        function renderMeramuFlow() {
            const stepIndicator = (currentStep) => {
                const steps = ['Size', 'Ingredients', 'Finalize'];
                return `
                    <div class="flex justify-center items-center space-x-2 mb-6">
                        ${steps.map((step, index) => `
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold ${index + 1 <= currentStep ? 'bg-amber-800 text-white' : 'bg-gray-200 text-gray-500'}">
                                    ${index + 1}
                                </div>
                                ${index < steps.length - 1 ? `<div class="h-1 w-12 ${index + 1 < currentStep ? 'bg-amber-800' : 'bg-gray-200'}"></div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            };

            let content = '';
            if (state.meramuStep === 1) {
                const isHot = state.meramuOrder.temp === 'Hot';
                content = `
                    <div class="p-5 bg-orange-50 min-h-screen">
                        <button id="meramu-back-home" class="mb-4 p-2 rounded-full bg-white shadow">${getArrowIcon()}</button>
                        ${stepIndicator(1)}
                        <h2 class="text-2xl font-bold text-amber-900 text-center mb-6">Choose Temperature & Size</h2>
                        <div class="space-y-4">
                            <div>
                                <h3 class="font-semibold text-amber-800 mb-2">Temperature</h3>
                                <div class="flex gap-4">
                                    <button data-temp="Hot" class="meramu-temp flex-1 p-4 rounded-lg font-bold text-center ${state.meramuOrder.temp === 'Hot' ? 'bg-amber-800 text-white' : 'bg-white'}">Hot</button>
                                    <button data-temp="Ice" class="meramu-temp flex-1 p-4 rounded-lg font-bold text-center ${state.meramuOrder.temp === 'Ice' ? 'bg-amber-800 text-white' : 'bg-white'}">Ice</button>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-amber-800 mb-2">Size</h3>
                                <div class="flex gap-4">
                                    <button data-size="Regular" class="meramu-size flex-1 p-4 rounded-lg font-bold text-center ${state.meramuOrder.size === 'Regular' ? 'bg-amber-800 text-white' : 'bg-white'}">Regular (${formatCurrency(PRICES.regular)})</button>
                                    ${!isHot ? `<button data-size="Xtra" class="meramu-size flex-1 p-4 rounded-lg font-bold text-center ${state.meramuOrder.size === 'Xtra' ? 'bg-amber-800 text-white' : 'bg-white'}">Xtra (${formatCurrency(PRICES.xtra)})</button>` : ''}
                                </div>
                            </div>
                        </div>
                        <button id="meramu-next" class="w-full mt-8 bg-amber-900 text-white font-bold py-4 rounded-xl text-lg">Next</button>
                    </div>
                `;
            } else if (state.meramuStep === 2) {
                content = `
                    <div class="p-5 bg-orange-50 min-h-screen">
                        <button id="meramu-prev" class="mb-4 p-2 rounded-full bg-white shadow">${getArrowIcon()}</button>
                        ${stepIndicator(2)}
                        <h2 class="text-2xl font-bold text-amber-900 text-center mb-2">Choose Ingredients</h2>
                        <p class="text-center text-amber-800 mb-6">Maximum 5 selections</p>
                        <div class="grid grid-cols-3 gap-4 mb-8">
                            ${REMPAH_OPTIONS.map(rempah => `<button data-ingredient="${rempah}" class="meramu-ingredient p-4 rounded-xl text-center font-semibold ${state.meramuOrder.ingredients.includes(rempah) ? 'bg-amber-800 text-white' : 'bg-white'}">${rempah}</button>`).join('')}
                        </div>
                        <button id="meramu-next" ${state.meramuOrder.ingredients.length === 0 ? 'disabled' : ''} class="w-full mt-8 bg-amber-900 text-white font-bold py-4 rounded-xl text-lg disabled:bg-gray-300">Next (${state.meramuOrder.ingredients.length}/5)</button>
                    </div>
                `;
            } else if (state.meramuStep === 3) {
                const isIce = state.meramuOrder.temp === 'Ice';
                content = `
                    <div class="p-5 bg-orange-50 min-h-screen">
                        <button id="meramu-prev" class="mb-4 p-2 rounded-full bg-white shadow">${getArrowIcon()}</button>
                        ${stepIndicator(3)}
                        <h2 class="text-2xl font-bold text-amber-900 text-center mb-6">Final Touches</h2>
                        <div class="space-y-6">
                            ${isIce ? `
                                <div>
                                    <h3 class="font-semibold text-amber-800 mb-2">Ice Level</h3>
                                    <div class="grid grid-cols-3 gap-2">
                                        ${['Less Ice', 'Normal Ice', 'Extra Ice'].map(level => `<button data-ice="${level}" class="meramu-ice p-3 rounded-lg font-semibold ${state.meramuOrder.iceLevel === level ? 'bg-amber-800 text-white' : 'bg-white'}">${level.replace(' Ice', '')}</button>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            <div>
                                <h3 class="font-semibold text-amber-800 mb-2">Sugar Type</h3>
                                <div class="grid grid-cols-3 gap-2">
                                    ${['Palm Sugar', 'White Sugar'].map(sugar => `<button data-sugar="${sugar}" class="meramu-sugar p-3 rounded-lg font-semibold ${state.meramuOrder.sugar === sugar ? 'bg-amber-800 text-white' : 'bg-white'}">${sugar.replace(' Sugar', '')}</button>`).join('')}
                                    <button data-sugar="Diabetic Sugar" class="meramu-sugar p-3 rounded-lg font-semibold ${state.meramuOrder.sugar === 'Diabetic Sugar' ? 'bg-amber-800 text-white' : 'bg-white'}">Diabetic (+${formatCurrency(PRICES.diabeticSugar)})</button>
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-amber-800 mb-2">Name Your Drink (Optional)</h3>
                                <input id="meramu-name" type="text" value="${state.meramuOrder.name}" class="w-full p-3 bg-white rounded-lg" placeholder="e.g., Budi's Power Potion" />
                            </div>
                        </div>
                        <button id="meramu-finish" class="w-full mt-8 bg-amber-900 text-white font-bold py-4 rounded-xl text-lg">Add to Cart</button>
                    </div>
                `;
            }
            mainContent.innerHTML = content;
            addMeramuListeners();
        }
        function addMeramuListeners() {
            document.getElementById('meramu-back-home')?.addEventListener('click', () => navigateTo('home'));
            document.getElementById('meramu-next')?.addEventListener('click', () => {
                state.meramuStep++;
                renderMeramuFlow();
            });
            document.getElementById('meramu-prev')?.addEventListener('click', () => {
                state.meramuStep--;
                renderMeramuFlow();
            });
            document.querySelectorAll('.meramu-temp').forEach(btn => btn.addEventListener('click', e => {
                updateMeramuOrder({ temp: e.target.dataset.temp, size: 'Regular' });
                renderMeramuFlow();
            }));
            document.querySelectorAll('.meramu-size').forEach(btn => btn.addEventListener('click', e => {
                updateMeramuOrder({ size: e.target.dataset.size });
                renderMeramuFlow();
            }));
            document.querySelectorAll('.meramu-ingredient').forEach(btn => btn.addEventListener('click', e => {
                const ingredient = e.target.dataset.ingredient;
                const currentIngredients = state.meramuOrder.ingredients;
                if (currentIngredients.includes(ingredient)) {
                    updateMeramuOrder({ ingredients: currentIngredients.filter(i => i !== ingredient) });
                } else if (currentIngredients.length < 5) {
                    updateMeramuOrder({ ingredients: [...currentIngredients, ingredient] });
                }
                renderMeramuFlow();
            }));
            document.querySelectorAll('.meramu-ice').forEach(btn => btn.addEventListener('click', e => {
                updateMeramuOrder({ iceLevel: e.target.dataset.ice });
                renderMeramuFlow();
            }));
            document.querySelectorAll('.meramu-sugar').forEach(btn => btn.addEventListener('click', e => {
                updateMeramuOrder({ sugar: e.target.dataset.sugar });
                renderMeramuFlow();
            }));
            document.getElementById('meramu-name')?.addEventListener('input', e => {
                updateMeramuOrder({ name: e.target.value });
            });
            document.getElementById('meramu-finish')?.addEventListener('click', () => {
                let price = state.meramuOrder.size === 'Regular' ? PRICES.regular : PRICES.xtra;
                if (state.meramuOrder.sugar === 'Diabetic Sugar') price += PRICES.diabeticSugar;
                const finalOrder = { 
                    ...state.meramuOrder, 
                    id: `meramu-${Date.now()}`, 
                    name: state.meramuOrder.name || 'Your Jamu', 
                    price, 
                    date: new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }) 
                };
                addToCart(finalOrder);
                // Reset for next time
                state.meramuStep = 1;
                state.meramuOrder = { temp: 'Hot', size: 'Regular', ingredients: [], iceLevel: 'Normal Ice', sugar: 'White Sugar', name: '' };
            });
        }
        
        // Cart Screen
        function renderCartScreen() {
            if (state.cart.length === 0) {
                return `
                    <div class="p-5 bg-orange-50 min-h-screen text-center flex flex-col justify-center items-center">
                        <h2 class="text-2xl font-bold text-amber-900 mb-4">Cart is Empty</h2>
                        <button id="cart-back-home" class="bg-amber-800 text-white font-semibold py-2 px-6 rounded-lg">Back to Home</button>
                    </div>
                `;
            }
            const item = state.cart[0]; // Assuming one item cart
            const deliveryCost = state.delivery === 'GrabSend' ? 15000 : 0;
            const total = item.price + PRICES.adminFee + deliveryCost;

            return `
                <div class="p-5 bg-orange-50 min-h-screen">
                    <button id="cart-back" class="mb-4 p-2 rounded-full bg-white shadow">${getArrowIcon()}</button>
                    <h2 class="text-2xl font-bold text-amber-900 text-center mb-6">Your Order</h2>
                    <div class="bg-white p-5 rounded-xl shadow space-y-3">
                        <div class="flex justify-between font-bold"><p>${item.name}</p><p>${formatCurrency(item.price)}</p></div>
                        <p class="text-sm text-gray-500 border-b pb-3">${item.ingredients.join(', ')}</p>
                        <div class="flex justify-between text-gray-600"><p>Admin Fee</p><p>${formatCurrency(PRICES.adminFee)}</p></div>
                        <div class="flex justify-between text-gray-600"><p>Delivery Cost</p><p>${formatCurrency(deliveryCost)}</p></div>
                        <div class="flex justify-between font-bold text-xl border-t pt-3"><p>Total Payment</p><p>${formatCurrency(total)}</p></div>
                    </div>
                    <!-- Form fields would go here -->
                    <button id="pay-now" class="w-full mt-8 bg-amber-900 text-white font-bold py-4 rounded-xl text-lg">Pay Now</button>
                </div>
            `;
        }
        function addCartScreenListeners() {
            document.getElementById('cart-back-home')?.addEventListener('click', () => navigateTo('home'));
            document.getElementById('cart-back')?.addEventListener('click', () => {
                const item = state.cart[0];
                const backScreen = item.id.startsWith('meramu') ? 'meramu' : 'home';
                navigateTo(backScreen);
            });
            document.getElementById('pay-now')?.addEventListener('click', () => {
                const item = state.cart[0];
                const total = item.price + PRICES.adminFee + (state.delivery === 'GrabSend' ? 15000 : 0);
                const transaction = {
                    ...item,
                    totalPrice: total,
                    status: 'Order Received',
                    date: new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })
                };
                state.transactionHistory.push(transaction);
                state.cart = [];
                navigateTo('orders');
            });
        }

        // Bot Screen
        function renderBotScreen() {
            const messagesHtml = state.botMessages.map(msg => `
                <div class="flex ${msg.from === 'bot' ? 'justify-start' : 'justify-end'}">
                    <div class="p-3 rounded-lg max-w-xs ${msg.from === 'bot' ? 'bg-white shadow' : 'bg-amber-800 text-white'}">${msg.text}</div>
                </div>
            `).join('');

            let controlsHtml = '';
            if (state.botStage === 'ask') {
                controlsHtml = `
                    <div class="mt-4 flex gap-2">
                        <input type="text" id="bot-input" value="${state.botUserInput}" placeholder="Describe your feelings..." class="w-full p-3 bg-white rounded-lg"/>
                        <button id="bot-send" class="bg-amber-900 text-white font-bold py-3 px-5 rounded-lg">Send</button>
                    </div>`;
            } else if (state.botStage === 'ask_save') {
                controlsHtml = `
                    <div class="mt-4 flex gap-2">
                        <button id="bot-save-recipe" class="flex-1 bg-amber-800 text-white font-bold py-3 rounded-lg">Yes, save it</button>
                        <button id="bot-no-thanks" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-lg">No, thanks</button>
                    </div>`;
            } else if (state.botStage === 'saved') {
                controlsHtml = `<button id="bot-end-chat" class="w-full mt-4 bg-amber-900 text-white font-bold py-4 rounded-xl text-lg">End Chat</button>`;
            }

            return `
                <div class="p-5 bg-orange-50 min-h-screen flex flex-col">
                    <div class="flex items-center mb-6">
                        <button id="bot-back-home" class="p-2 rounded-full bg-white shadow">${getArrowIcon()}</button>
                        <h2 class="text-2xl font-bold text-amber-900 text-center flex-1">Klinik Si Mbok Jamu</h2>
                    </div>
                    <div class="flex-grow space-y-4 overflow-y-auto pb-4">${messagesHtml}</div>
                    ${controlsHtml}
                </div>
            `;
        }
        function addBotScreenListeners() {
            document.getElementById('bot-back-home')?.addEventListener('click', () => navigateTo('home'));
            const input = document.getElementById('bot-input');
            input?.addEventListener('input', e => state.botUserInput = e.target.value);
            
            const handleSend = () => {
                if (!state.botUserInput.trim()) return;
                state.botMessages.push({ from: 'you', text: state.botUserInput });
                state.botUserInput = '';
                state.botStage = 'diagnosing';
                renderApp();

                setTimeout(() => {
                    state.botMessages.push({ from: 'bot', text: "Diagnosing..." });
                    renderApp();
                }, 500);
                setTimeout(() => {
                    state.botMessages.push({ from: 'bot', text: "Here's your health complaint: Fatigue and a slight cold." });
                    state.botMessages.push({ from: 'bot', text: "Recipe Suggestion: A warm blend of Ginger, Lemongrass, and Cinnamon." });
                    renderApp();
                }, 1500);
                setTimeout(() => {
                    state.botMessages.push({ from: 'bot', text: "Do you wish to save this recipe?" });
                    state.botStage = 'ask_save';
                    renderApp();
                }, 2500);
            };

            document.getElementById('bot-send')?.addEventListener('click', handleSend);
            input?.addEventListener('keypress', e => { if (e.key === 'Enter') handleSend(); });

            document.getElementById('bot-save-recipe')?.addEventListener('click', () => {
                const recipeNumber = `#SIMBOK${String(state.savedRecipes.length + 1).padStart(3, '0')}`;
                state.savedRecipes.push({
                    id: recipeNumber, name: 'Anti Rusing', date: new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }),
                    ingredients: ['Ginger', 'Lemongrass', 'Cinnamon'], type: 'Simbok'
                });
                state.botMessages.push({ from: 'you', text: "Yes" });
                state.botMessages.push({ from: 'bot', text: `OK! Here's your recipe number: ${recipeNumber}` });
                state.botStage = 'saved';
                renderApp();
            });
            document.getElementById('bot-no-thanks')?.addEventListener('click', () => navigateTo('home'));
            document.getElementById('bot-end-chat')?.addEventListener('click', () => navigateTo('home'));
        }

        // --- MODAL LOGIC ---
        function openProductModal(product) {
            let optionsHtml = '';
            if (product.type === 'drink') {
                optionsHtml = `
                    <div class="mb-4">
                        <h4 class="font-semibold text-amber-800 mb-2">Pilih Gula</h4>
                        <div class="flex gap-2">
                            <button data-option="White Sugar" class="modal-option-drink flex-1 p-3 rounded-lg font-semibold text-sm bg-amber-800 text-white">White Sugar</button>
                            <button data-option="Palm Sugar" class="modal-option-drink flex-1 p-3 rounded-lg font-semibold text-sm bg-gray-200">Palm Sugar</button>
                        </div>
                    </div>
                `;
            } else if (product.type === 'snack') {
                optionsHtml = `
                    <div class="mb-4">
                        <h4 class="font-semibold text-amber-800 mb-2">Pilih Sambal</h4>
                        <div class="space-y-2">
                             <button data-option="Tanpa Sambal" class="modal-option-snack w-full p-3 rounded-lg font-semibold text-left bg-amber-800 text-white">Tanpa Sambal</button>
                             <button data-option="Sambal Roa" class="modal-option-snack w-full p-3 rounded-lg font-semibold text-left bg-gray-200">Sambal Roa (+${formatCurrency(PRICES.sambal)})</button>
                             <button data-option="Sambal Kecap" class="modal-option-snack w-full p-3 rounded-lg font-semibold text-left bg-gray-200">Sambal Kecap (+${formatCurrency(PRICES.sambal)})</button>
                        </div>
                    </div>
                `;
            }

            productModalContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-amber-900">${product.name}</h3>
                    <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <img src="${product.image}" alt="${product.name}" class="w-full h-40 rounded-lg object-cover mb-4" />
                ${optionsHtml}
                <button id="modal-add-to-cart-btn" class="w-full bg-amber-900 text-white font-bold py-3 rounded-xl text-lg hover:bg-amber-800 transition-colors">
                    Add to Cart
                </button>
            `;
            productModal.classList.remove('hidden');
            addModalListeners(product);
        }

        function addModalListeners(product) {
            let selectedOption = product.type === 'drink' ? 'White Sugar' : 'Tanpa Sambal';

            document.getElementById('modal-close-btn').addEventListener('click', () => productModal.classList.add('hidden'));
            
            document.querySelectorAll('.modal-option-drink').forEach(btn => btn.addEventListener('click', e => {
                document.querySelectorAll('.modal-option-drink').forEach(b => b.classList.replace('bg-amber-800', 'bg-gray-200') || b.classList.remove('text-white'));
                e.target.classList.replace('bg-gray-200', 'bg-amber-800');
                e.target.classList.add('text-white');
                selectedOption = e.target.dataset.option;
            }));

            document.querySelectorAll('.modal-option-snack').forEach(btn => btn.addEventListener('click', e => {
                document.querySelectorAll('.modal-option-snack').forEach(b => b.classList.replace('bg-amber-800', 'bg-gray-200') || b.classList.remove('text-white'));
                e.target.classList.replace('bg-gray-200', 'bg-amber-800');
                e.target.classList.add('text-white');
                selectedOption = e.target.dataset.option;
            }));

            document.getElementById('modal-add-to-cart-btn').addEventListener('click', () => {
                let finalPrice = product.price;
                let nameSuffix = '';
                if (product.type === 'snack' && selectedOption !== 'Tanpa Sambal') {
                    finalPrice += PRICES.sambal;
                }
                nameSuffix = `(${selectedOption})`;

                addToCart({
                    ...product,
                    price: finalPrice,
                    name: `${product.name} ${nameSuffix}`,
                    ingredients: [product.category, selectedOption]
                });
                productModal.classList.add('hidden');
            });
        }
        
        function addToCart(item) {
            state.cart = [item]; // Simple cart, replace item
            navigateTo('cart');
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => navigateTo(item.dataset.screen));
            });
            renderApp();
        });
    </script>
</body>
</html>
