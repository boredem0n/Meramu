<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meramu Jamu</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LeafletJS CSS & JS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        #map-container { height: 300px; z-index: 0; }
        .checkout-dark { background-color: #1E1E1E; color: white; }
        .checkout-dark-panel { background-color: #2C2C2C; }
        .checkout-dark-input { background-color: #2C2C2C; border: 1px solid #4A4A4A; }
        .checkout-dark-input:focus { outline: none; border-color: #D97706; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="font-sans antialiased bg-white max-w-md mx-auto shadow-2xl relative min-h-screen">
        <div id="main-content" class="pb-24">
            <!-- Screens will be rendered here by JavaScript -->
        </div>

        <!-- Bottom Navigation Bar -->
        <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 h-20 z-40 max-w-md mx-auto">
            <!-- Navigation HTML remains the same -->
            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-200 h-16">
                <div class="flex justify-around h-full">
                    <button data-screen="home" class="nav-item flex flex-col items-center justify-center pt-2 transition-colors w-1/5">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                        <span class="text-xs font-semibold">Home</span>
                    </button>
                    <button data-screen="voucher" class="nav-item flex flex-col items-center justify-center pt-2 transition-colors w-1/5">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path></svg>
                        <span class="text-xs font-semibold">Voucher</span>
                    </button>
                    <div class="w-1/5"></div>
                    <button data-screen="orders" class="nav-item flex flex-col items-center justify-center pt-2 transition-colors w-1/5">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                        <span class="text-xs font-semibold">Orders</span>
                    </button>
                    <button data-screen="account" class="nav-item flex flex-col items-center justify-center pt-2 transition-colors w-1/5">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        <span class="text-xs font-semibold">Account</span>
                    </button>
                </div>
            </div>
            <div class="absolute bottom-4 left-1/2 -translate-x-1/2">
                <button data-screen="meramu" class="nav-item bg-amber-900 text-white w-20 h-20 rounded-full flex items-center justify-center shadow-2xl border-4 border-white">
                    <svg class="w-10 h-10" fill="currentColor" viewBox="0 0 20 20"><path d="M5 3a1 1 0 000 2c0 1.1.9 2 2 2h6a2 2 0 002-2 1 1 0 100-2H5z"></path><path fill-rule="evenodd" d="M3 8a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM5.05 11.636a1 1 0 01.707.293l2 2a1 1 0 01-1.414 1.414l-2-2a1 1 0 01.707-1.707zM14.95 11.636a1 1 0 01.707 1.707l-2 2a1 1 0 01-1.414-1.414l2-2a1 1 0 01.707-.293zM10 15a1 1 0 011 1v2a1 1 0 11-2 0v-2a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </nav>

        <!-- Modals -->
        <div id="map-modal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-2xl p-4 w-11/12 max-w-sm flex flex-col">
                <h3 class="text-lg font-bold text-center mb-2">Pilih Lokasi Pengantaran</h3>
                <div id="map-container" class="w-full rounded-lg"></div>
                <button id="confirm-location-btn" class="w-full mt-4 bg-amber-800 text-white font-bold py-3 rounded-lg">Konfirmasi Lokasi</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. GLOBAL STATE & CONSTANTS ---
        const AppState = {
            screen: 'home',
            cart: [],
            deliveryOption: 'Jamu Gendong',
            deliveryCost: 0,
            recipientAddress: '',
            paymentMethod: 'QRIS',
            eWalletOption: null,
        };

        const CONSTANTS = {
            PRICES: { regular: 14000, xtra: 19000, diabeticSugar: 5000, adminFee: 1000, sambal: 500, deliveryFee: 10000 },
            TOKO_COORDS: [-6.9830, 110.4338], // Semarang
        };

        const DOM = {
            mainContent: document.getElementById('main-content'),
            bottomNav: document.getElementById('bottom-nav'),
            mapModal: document.getElementById('map-modal'),
        };

        // --- 2. UTILITY & HELPER FUNCTIONS ---
        const Utils = {
            formatCurrency: (value) => `Rp ${value.toLocaleString('id-ID')}`,
            calculateDistance: (lat1, lon1, lat2, lon2) => {
                const R = 6371; // Earth radius in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = 0.5 - Math.cos(dLat)/2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * (1 - Math.cos(dLon)) / 2;
                return R * 2 * Math.asin(Math.sqrt(a));
            },
            getAddressFromCoords: async (lat, lng) => {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                    const data = await response.json();
                    return data.display_name || `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                } catch {
                    return "Lokasi tidak dapat ditemukan";
                }
            },
        };

        // --- 3. CORE APP LOGIC (NAVIGATION & RENDERING) ---
        const App = {
            init() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => this.navigateTo(item.dataset.screen));
                });
                this.navigateTo('home');
            },
            navigateTo(screenName) {
                AppState.screen = screenName;
                this.render();
            },
            render() {
                DOM.mainContent.innerHTML = '';
                DOM.bottomNav.style.display = 'block';

                const screenModule = Screens[AppState.screen] || Screens.home;
                DOM.mainContent.innerHTML = screenModule.render();
                screenModule.addListeners();

                if (screenModule.hideNav) {
                    DOM.bottomNav.style.display = 'none';
                }
                this.updateNavUI();
            },
            updateNavUI() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    const svg = item.querySelector('svg');
                    const span = item.querySelector('span');
                    const isActive = item.dataset.screen === AppState.screen;
                    svg?.classList.toggle('text-amber-800', isActive);
                    svg?.classList.toggle('text-gray-400', !isActive);
                    span?.classList.toggle('text-amber-800', isActive);
                    span?.classList.toggle('text-gray-400', !isActive);
                });
            },
            addToCart(item) {
                AppState.cart = [{ ...item, ingredients: item.ingredients || [item.category] }];
                this.navigateTo('cart');
            }
        };

        // --- 4. SCREEN MODULES (UI & LOGIC PER SCREEN) ---
        const Screens = {
            home: {
                render() {
                    return `<div class="bg-orange-50 min-h-screen">
                                <header class="bg-amber-800 text-white p-5 rounded-b-3xl shadow-lg">
                                    <div class="flex justify-between items-center mb-4">
                                        <h1 class="text-2xl font-bold tracking-wider">MERAMU</h1>
                                        <div class="bg-white text-amber-800 font-bold px-4 py-1 rounded-full text-sm shadow-md">23 POIN</div>
                                    </div>
                                    <p class="text-lg font-light">Hi, Simbok!</p>
                                </header>
                                <!-- ... other home content ... -->
                            </div>`;
                },
                addListeners() { /* Add home screen listeners here */ }
            },
            cart: {
                render() {
                    if (AppState.cart.length === 0) {
                        return `<div class="p-5 text-center"><h2 class="font-bold">Cart is Empty</h2><button id="cart-back-home" class="mt-4 bg-amber-800 text-white font-semibold py-2 px-6 rounded-lg">Back to Home</button></div>`;
                    }
                    const item = AppState.cart[0];
                    const total = item.price + CONSTANTS.PRICES.adminFee + AppState.deliveryCost;

                    let detailsHtml = '';
                    if (item.details) {
                        const detailsList = Object.entries(item.details)
                            .filter(([key, value]) => value !== null && !['name', 'ingredients'].includes(key))
                            .map(([key, value]) => `<span class="capitalize">${key.replace('Level', ' Level')}: <strong>${value}</strong></span>`)
                            .join(' &bull; ');
                        if (detailsList) detailsHtml = `<p class="text-xs text-gray-400 mt-1">${detailsList}</p>`;
                    }

                    return `<div class="checkout-dark min-h-screen p-5 pb-28">
                                <h2 class="text-center text-2xl font-bold mb-6">Your Order</h2>
                                <div class="checkout-dark-panel rounded-xl p-4 space-y-3 mb-6">
                                    <div class="flex justify-between font-bold"><p>${item.name}</p><p>${Utils.formatCurrency(item.price)}</p></div>
                                    <p class="text-sm text-gray-300">${item.ingredients.join(', ')}</p>
                                    ${detailsHtml}
                                    <div class="border-b border-gray-600 pt-2"></div>
                                    <div class="flex justify-between text-gray-300 pt-2"><p>Admin Fee</p><p>${Utils.formatCurrency(CONSTANTS.PRICES.adminFee)}</p></div>
                                    <div class="flex justify-between text-gray-300"><p>Delivery Cost</p><p id="delivery-cost-display">${Utils.formatCurrency(AppState.deliveryCost)}</p></div>
                                    <div class="flex justify-between font-bold text-xl border-t border-gray-600 pt-3"><p>Total Payment</p><p id="total-payment-display">${Utils.formatCurrency(total)}</p></div>
                                </div>
                                <div class="space-y-4">
                                    <!-- Form Fields -->
                                    <div>
                                        <label class="font-semibold text-amber-500">Recipient Name</label>
                                        <input type="text" value="Budi tikus" class="w-full checkout-dark-input p-3 rounded-lg mt-1">
                                    </div>
                                    <div>
                                        <label class="font-semibold text-amber-500">Area/Address</label>
                                        <input type="text" id="address-input" value="${AppState.recipientAddress}" placeholder="Pilih lokasi dari peta" class="w-full checkout-dark-input p-3 rounded-lg mt-1" readonly>
                                    </div>
                                    <!-- Delivery Options -->
                                    <div>
                                        <label class="font-semibold text-amber-500 mb-2 block">Delivery Option</label>
                                        <div class="flex gap-4">
                                            <button data-option="Pick Up" class="delivery-option flex-1 p-3 rounded-lg font-semibold text-center ${AppState.deliveryOption === 'Pick Up' ? 'bg-amber-600' : 'checkout-dark-panel'}">Pick Up</button>
                                            <button data-option="Jamu Gendong" class="delivery-option flex-1 p-3 rounded-lg font-semibold text-center ${AppState.deliveryOption === 'Jamu Gendong' ? 'bg-amber-600' : 'checkout-dark-panel'}">Jamu Gendong</button>
                                        </div>
                                    </div>
                                    <div id="map-button-container">
                                       <button id="open-map-btn" class="w-full mt-2 bg-blue-600 text-white font-bold py-3 rounded-lg">Pilih Lokasi di Peta</button>
                                    </div>
                                    <!-- Payment Options -->
                                    <div>
                                        <label class="font-semibold text-amber-500 mb-2 block">Payment Method</label>
                                        <div class="flex gap-2">
                                            <button data-payment="QRIS" class="payment-method flex-1 p-3 rounded-lg font-semibold ${AppState.paymentMethod === 'QRIS' ? 'bg-amber-600' : 'checkout-dark-panel'}">QRIS</button>
                                            <button data-payment="E-Wallet" class="payment-method flex-1 p-3 rounded-lg font-semibold ${AppState.paymentMethod === 'E-Wallet' ? 'bg-amber-600' : 'checkout-dark-panel'}">E-Wallet</button>
                                            <button data-payment="Card" class="payment-method flex-1 p-3 rounded-lg font-semibold ${AppState.paymentMethod === 'Card' ? 'bg-amber-600' : 'checkout-dark-panel'}">Card</button>
                                        </div>
                                    </div>
                                    <div id="ewallet-options" class="${AppState.paymentMethod === 'E-Wallet' ? '' : 'hidden'} mt-2">
                                        <div class="flex gap-2 justify-center">
                                            <button data-ewallet="OVO" class="ewallet-option flex-1 p-2 rounded-lg text-sm ${AppState.eWalletOption === 'OVO' ? 'bg-purple-600' : 'checkout-dark-panel'}">OVO</button>
                                            <button data-ewallet="Dana" class="ewallet-option flex-1 p-2 rounded-lg text-sm ${AppState.eWalletOption === 'Dana' ? 'bg-blue-600' : 'checkout-dark-panel'}">Dana</button>
                                            <button data-ewallet="Shopeepay" class="ewallet-option flex-1 p-2 rounded-lg text-sm ${AppState.eWalletOption === 'Shopeepay' ? 'bg-orange-600' : 'checkout-dark-panel'}">ShopeePay</button>
                                        </div>
                                    </div>
                                    <div id="qris-display" class="${AppState.paymentMethod === 'QRIS' ? '' : 'hidden'} mt-4"><div class="checkout-dark-panel p-4 rounded-lg flex justify-center"><img src="https://placehold.co/200x200/ffffff/000000?text=SCAN+QRIS" alt="QRIS Code" /></div></div>
                                    <button id="pay-now-btn" class="w-full mt-6 bg-green-600 text-white font-bold py-4 rounded-xl text-lg">Pay Now</button>
                                </div>
                            </div>`;
                },
                addListeners() {
                    document.getElementById('cart-back-home')?.addEventListener('click', () => App.navigateTo('home'));
                    
                    document.querySelectorAll('.delivery-option').forEach(btn => btn.addEventListener('click', e => {
                        AppState.deliveryOption = e.target.dataset.option;
                        AppState.deliveryCost = 0;
                        AppState.recipientAddress = AppState.deliveryOption === 'Pick Up' ? 'Ambil di Toko' : '';
                        App.render();
                    }));

                    const openMapBtn = document.getElementById('open-map-btn');
                    if (openMapBtn) {
                        openMapBtn.style.display = AppState.deliveryOption === 'Pick Up' ? 'none' : 'block';
                        openMapBtn.addEventListener('click', () => MapModule.open());
                    }
                    
                    document.querySelectorAll('.payment-method').forEach(btn => btn.addEventListener('click', e => {
                        AppState.paymentMethod = e.target.dataset.payment;
                        AppState.eWalletOption = null;
                        App.render();
                    }));

                    document.querySelectorAll('.ewallet-option').forEach(btn => btn.addEventListener('click', e => {
                        AppState.eWalletOption = e.target.dataset.ewallet;
                        App.render();
                    }));
                }
            },
            // Define other screens (meramu, bot, etc.) here in the same modular way
        };

        // --- 5. MAP MODULE ---
        const MapModule = {
            mapInstance: null,
            mapMarker: null,
            open() {
                DOM.mapModal.classList.remove('hidden');
                setTimeout(() => {
                    navigator.geolocation.getCurrentPosition(
                        pos => this.init(pos.coords.latitude, pos.coords.longitude),
                        () => this.init(CONSTANTS.TOKO_COORDS[0], CONSTANTS.TOKO_COORDS[1])
                    );
                }, 100);
            },
            init(lat, lng) {
                if (this.mapInstance) {
                    this.mapInstance.invalidateSize();
                    this.mapInstance.setView([lat, lng], 15);
                } else {
                    this.mapInstance = L.map('map-container').setView([lat, lng], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.mapInstance);
                    document.getElementById('confirm-location-btn').addEventListener('click', () => this.confirm());
                }
                if (this.mapMarker) {
                    this.mapMarker.setLatLng([lat, lng]);
                } else {
                    this.mapMarker = L.marker([lat, lng], { draggable: true }).addTo(this.mapInstance);
                }
                this.mapInstance.on('cli